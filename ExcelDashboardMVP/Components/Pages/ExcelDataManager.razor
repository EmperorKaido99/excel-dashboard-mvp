@page "/data-table"
@rendermode InteractiveServer
@using ExcelDashboardMVP.Models
@using ExcelDashboardMVP.Services
@using Microsoft.JSInterop
@inject ExcelDataService DataService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JS
@inject ILogger<ExcelDataManager> Logger
@implements IDisposable

<PageTitle>Data Table</PageTitle>

@* ── UPLOAD ZONE ──────────────────────────────────────────────────────────── *@
<MudPaper Elevation="3" Class="ma-4 pa-6">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h5" Color="Color.Primary">
            <MudIcon Icon="@Icons.Material.Filled.UploadFile" Class="mr-2" />
            Excel Upload
        </MudText>
        <MudButton StartIcon="@Icons.Material.Filled.Download"
                   Variant="Variant.Outlined" Color="Color.Secondary"
                   Size="Size.Small" OnClick="DownloadTemplate">
            Download Template
        </MudButton>
    </MudStack>

    <div class="@(_isDragging ? "upload-zone upload-zone--active" : "upload-zone")"
         @ondragenter="OnDragEnter" @ondragleave="OnDragLeave"
         @ondragover:preventDefault="true" @ondrop="OnDrop">

        <MudIcon Icon="@Icons.Material.Filled.CloudUpload"
                 Style="font-size: 3rem; color: #1074d6; opacity: 0.7;" />
        <MudText Typo="Typo.body1" Class="mt-2 mb-1">
            Drag &amp; drop your <strong>.xlsx</strong> or <strong>.xls</strong> file here
        </MudText>
        <MudText Typo="Typo.caption" Color="Color.Secondary">or</MudText>

        <MudFileUpload T="IBrowserFile" FilesChanged="HandleFileChanged"
                       Accept=".xlsx,.xls" Disabled="_isLoading" Class="mt-2">
            <ActivatorContent>
                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.FolderOpen" Disabled="_isLoading">
                    Browse File
                </MudButton>
            </ActivatorContent>
        </MudFileUpload>

        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
            Expected columns (any order): Name · Surname · Identifier · EmailAddress ·
            LocalMunicipality · HostCompany · LeadCompany · JobType ·
            DemographicGroup · Sex · ContactDetails · EmploymentStatus · PersonDisability
        </MudText>

        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true"
                               Class="mt-4" Style="width: 80%;" />
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">Parsing file…</MudText>
        }
        else if (_selectedFileName != null)
        {
            <MudChip T="string" Color="Color.Success"
                     Icon="@Icons.Material.Filled.CheckCircle" Class="mt-3">
                @_selectedFileName — @_importedCount records imported
            </MudChip>
        }
    </div>

    @* Validation errors *@
    @if (_validationErrors.Any())
    {
        <MudAlert Severity="Severity.Error" Class="mt-3" Dense="true" ShowCloseIcon="true"
                  CloseIconClicked="() => _validationErrors.Clear()">
            <strong>Import failed — missing required columns:</strong>
            @string.Join(", ", _validationErrors)
            <br />
            <MudText Typo="Typo.caption">
                Download the template above to see the correct column names.
            </MudText>
        </MudAlert>
    }
</MudPaper>

@* ── TOOLBAR ─────────────────────────────────────────────────────────────── *@
<MudPaper Elevation="3" Class="ma-4 pa-4">

    <MudGrid Class="mb-3">
        <MudItem xs="12" sm="5">
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.TableChart" Class="mr-1" />
                Participant Data
            </MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                Showing <strong>@_filteredCount</strong> of <strong>@_totalCount</strong> records
                @if (HasActiveFilters)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="ml-2">
                        @ActiveFilterCount filter(s) active
                    </MudChip>
                }
            </MudText>
        </MudItem>

        <MudItem xs="12" sm="7">
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center"
                      Justify="Justify.FlexEnd">

                <MudTextField @bind-Value="_globalSearch"
                              Placeholder="Search all columns…"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Variant="Variant.Outlined" Margin="Margin.Dense"
                              Style="min-width:180px;" Immediate="true"
                              DebounceInterval="200"
                              OnDebounceIntervalElapsed="ApplyFilters" />

                <MudButton StartIcon="@Icons.Material.Filled.FilterAlt"
                           Variant="@(_showFilters ? Variant.Filled : Variant.Outlined)"
                           Color="@(HasActiveFilters ? Color.Warning : Color.Primary)"
                           OnClick="ToggleFilters" Size="Size.Small">
                    Filters @(HasActiveFilters ? $"({ActiveFilterCount})" : "")
                </MudButton>

                @if (HasActiveFilters)
                {
                    <MudButton StartIcon="@Icons.Material.Filled.FilterAltOff"
                               Variant="Variant.Outlined" Color="Color.Error"
                               OnClick="ClearAllFilters" Size="Size.Small">
                        Clear
                    </MudButton>
                }

                <MudButton StartIcon="@Icons.Material.Filled.Add"
                           Variant="Variant.Filled" Color="Color.Primary"
                           Size="Size.Small" OnClick="OpenAddDialog">
                    Add
                </MudButton>

                <MudButton StartIcon="@Icons.Material.Filled.FileDownload"
                           Variant="Variant.Outlined" Color="Color.Success"
                           Size="Size.Small" OnClick="() => ExportData(false)"
                           Disabled="@(_filteredCount == 0)">
                    Export Filtered
                </MudButton>

                <MudButton StartIcon="@Icons.Material.Filled.Download"
                           Variant="Variant.Outlined" Color="Color.Success"
                           Size="Size.Small" OnClick="() => ExportData(true)"
                           Disabled="@(_totalCount == 0)">
                    Export All
                </MudButton>
            </MudStack>
        </MudItem>
    </MudGrid>

    @* ── FILTER PANEL ──────────────────────────────────────────────────────── *@
    @if (_showFilters)
    {
        <MudPaper Outlined="true" Class="pa-4 mb-3"
                  Style="background: #f8f9ff; border-radius: 8px;">
            <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.FilterAlt"
                         Size="Size.Small" Class="mr-1" />
                Column Filters — combine any number of filters simultaneously
            </MudText>

            <MudGrid Spacing="2">
                @* Text filters *@
                @foreach (var fld in _textFilters)
                {
                    <MudItem xs="12" sm="6" md="4">
                        <MudTextField Value="@fld.Value"
                                      Label="@fld.Label"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Immediate="true"
                                      DebounceInterval="200"
                                      ValueChanged="(string v) => OnTextFilterChanged(fld, v)"
                                      Adornment="@(!string.IsNullOrWhiteSpace(fld.Value) ? Adornment.End : Adornment.None)"
                                      AdornmentIcon="@Icons.Material.Filled.Close"
                                      OnAdornmentClick="() => ClearTextField(fld)" />
                    </MudItem>
                }

                @* Dropdown: Sex — Value + ValueChanged only (never mix with @bind-Value) *@
                <MudItem xs="12" sm="6" md="4">
                    <MudSelect Value="@_filterSex"
                               Label="Sex / Gender"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               Clearable="true"
                               ValueChanged="(string v) => OnSexFilterChanged(v)">
                        @foreach (var o in _sexOptions)
                        {
                            <MudSelectItem Value="@o">@o</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                @* Dropdown: Employment Status *@
                <MudItem xs="12" sm="6" md="4">
                    <MudSelect Value="@_filterStatus"
                               Label="Employment Status"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               Clearable="true"
                               ValueChanged="(string v) => OnStatusFilterChanged(v)">
                        @foreach (var o in _statusOptions)
                        {
                            <MudSelectItem Value="@o">@o</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                @* Dropdown: Demographic Group *@
                <MudItem xs="12" sm="6" md="4">
                    <MudSelect Value="@_filterDemographic"
                               Label="Demographic Group"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               Clearable="true"
                               ValueChanged="(string v) => OnDemographicFilterChanged(v)">
                        @foreach (var o in _demographicOptions)
                        {
                            <MudSelectItem Value="@o">@o</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                @* Dropdown: Job Type *@
                <MudItem xs="12" sm="6" md="4">
                    <MudSelect Value="@_filterJobType"
                               Label="Job Type"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               Clearable="true"
                               ValueChanged="(string v) => OnJobTypeFilterChanged(v)">
                        @foreach (var o in _jobTypeOptions)
                        {
                            <MudSelectItem Value="@o">@o</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                @* Dropdown: Disability *@
                <MudItem xs="12" sm="6" md="4">
                    <MudSelect Value="@_filterDisability"
                               Label="Person Disability"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               Clearable="true"
                               ValueChanged="(string v) => OnDisabilityFilterChanged(v)">
                        <MudSelectItem Value="@("yes")">Has Disability</MudSelectItem>
                        <MudSelectItem Value="@("no")">No Disability</MudSelectItem>
                    </MudSelect>
                </MudItem>
            </MudGrid>

            <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-3">
                <MudButton Variant="Variant.Outlined" Color="Color.Error"
                           StartIcon="@Icons.Material.Filled.RestartAlt"
                           OnClick="ClearAllFilters">
                    Reset All Filters
                </MudButton>
            </MudStack>
        </MudPaper>
    }

    @* ── DATA GRID ─────────────────────────────────────────────────────────── *@
    @if (_totalCount == 0)
    {
        <MudStack AlignItems="AlignItems.Center" Class="py-12">
            <MudIcon Icon="@Icons.Material.Filled.TableView"
                     Style="font-size:5rem;opacity:0.2;" />
            <MudText Typo="Typo.h6" Color="Color.Secondary">No data loaded yet</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Upload an Excel file above to get started, or download the template to see the expected format.
            </MudText>
        </MudStack>
    }
    else if (_filteredCount == 0)
    {
        <MudStack AlignItems="AlignItems.Center" Class="py-8">
            <MudIcon Icon="@Icons.Material.Filled.SearchOff"
                     Style="font-size:4rem;opacity:0.3;" />
            <MudText Typo="Typo.h6" Color="Color.Secondary">
                No records match the current filters
            </MudText>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                       OnClick="ClearAllFilters">
                Clear Filters
            </MudButton>
        </MudStack>
    }
    else
    {
        <MudDataGrid T="PersonRecord"
                     Items="@_displayedRecords"
                     Dense="true" Hover="true" Striped="true" Bordered="true"
                     Filterable="false"
                     @bind-RowsPerPage="_pageSize"
                     Style="overflow-x:auto;">
            <Columns>
                <PropertyColumn Property="x => x.RowNumber"         Title="#"             Sortable="true" />
                <PropertyColumn Property="x => x.Name"              Title="Name"          Sortable="true" />
                <PropertyColumn Property="x => x.Surname"           Title="Surname"       Sortable="true" />
                <PropertyColumn Property="x => x.Identifier"        Title="Identifier"    Sortable="true" />
                <PropertyColumn Property="x => x.EmailAddress"      Title="Email"         Sortable="true" />
                <PropertyColumn Property="x => x.LocalMunicipality" Title="Municipality"  Sortable="true" />
                <PropertyColumn Property="x => x.HostCompany"       Title="Host Company"  Sortable="true" />
                <PropertyColumn Property="x => x.LeadCompany"       Title="Lead Company"  Sortable="true" />
                <PropertyColumn Property="x => x.JobType"           Title="Job Type"      Sortable="true" />
                <PropertyColumn Property="x => x.DemographicGroup"  Title="Demographic"   Sortable="true" />
                <PropertyColumn Property="x => x.Sex"               Title="Sex"           Sortable="true" />
                <PropertyColumn Property="x => x.ContactDetails"    Title="Contact"       Sortable="true" />
                <PropertyColumn Property="x => x.EmploymentStatus"  Title="Emp. Status"   Sortable="true" />
                <TemplateColumn Title="Disability" Sortable="false">
                    <CellTemplate>
                        <MudChip T="string" Size="Size.Small"
                                 Color="@(context.Item.HasDisability ? Color.Warning : Color.Default)">
                            @(context.Item.HasDisability ? "Yes"
                              : string.IsNullOrWhiteSpace(context.Item.PersonDisability) ? "—"
                              : context.Item.PersonDisability)
                        </MudChip>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Actions" Sortable="false">
                    <CellTemplate>
                        <MudStack Row="true" Spacing="0">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Size="Size.Small" Color="Color.Primary"
                                           OnClick="() => OpenEditDialog(context.Item)" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Size="Size.Small" Color="Color.Error"
                                           OnClick="() => ConfirmDelete(context.Item)" />
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <PagerContent>
                <MudDataGridPager T="PersonRecord"
                                  PageSizeOptions="@(new[] {10, 25, 50, 100, 500})" />
            </PagerContent>
        </MudDataGrid>
    }
</MudPaper>

@* ── ADD / EDIT DIALOG ──────────────────────────────────────────────────────── *@
@if (_showDialog && _editingRecord != null)
{
    <MudOverlay Visible="true" DarkBackground="true" ZIndex="9999" AutoClose="false">
        <MudPaper Class="pa-6 dialog-panel" Elevation="8">
            <MudText Typo="Typo.h6" Class="mb-4">
                @(_isNewRecord ? "Add New Record" : "Edit Record")
            </MudText>
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_editingRecord.Name" Label="Name"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" Required="true" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_editingRecord.Surname" Label="Surname"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" Required="true" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_editingRecord.Identifier" Label="Identifier"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_editingRecord.EmailAddress" Label="Email Address"
                                  Variant="Variant.Outlined" Margin="Margin.Dense"
                                  InputType="InputType.Email" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_editingRecord.LocalMunicipality"
                                  Label="Local Municipality"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_editingRecord.HostCompany" Label="Host Company"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_editingRecord.LeadCompany" Label="Lead Company"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_editingRecord.JobType" Label="Job Type"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_editingRecord.DemographicGroup"
                                  Label="Demographic Group"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="_editingRecord.Sex" Label="Sex / Gender"
                               Variant="Variant.Outlined" Margin="Margin.Dense">
                        <MudSelectItem Value="@("Male")">Male</MudSelectItem>
                        <MudSelectItem Value="@("Female")">Female</MudSelectItem>
                        <MudSelectItem Value="@("Other")">Other</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_editingRecord.ContactDetails"
                                  Label="Contact Details"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_editingRecord.EmploymentStatus"
                                  Label="Employment Status"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="_editingRecord.PersonDisability"
                               Label="Person Disability"
                               Variant="Variant.Outlined" Margin="Margin.Dense">
                        <MudSelectItem Value="@("Y")">Yes</MudSelectItem>
                        <MudSelectItem Value="@("N")">No</MudSelectItem>
                    </MudSelect>
                </MudItem>
            </MudGrid>

            <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2" Class="mt-4">
                <MudButton OnClick="CloseDialog" Color="Color.Default" Variant="Variant.Text">
                    Cancel
                </MudButton>
                <MudButton OnClick="SaveRecord" Color="Color.Primary" Variant="Variant.Filled">
                    @(_isNewRecord ? "Add" : "Save")
                </MudButton>
            </MudStack>
        </MudPaper>
    </MudOverlay>
}

@code {
    // ── Upload ───────────────────────────────────────────────────────────────
    private bool _isLoading;
    private bool _isDragging;
    private string? _selectedFileName;
    private int _importedCount;
    private List<string> _validationErrors = new();

    // ── Grid ─────────────────────────────────────────────────────────────────
    private string _globalSearch = string.Empty;
    private List<PersonRecord> _displayedRecords = new();
    private int _totalCount   => DataService.GetRecordCount();
    private int _filteredCount => _displayedRecords.Count;
    private int _pageSize = 25;
    private bool _showFilters;

    // ── Per-column text filter model ─────────────────────────────────────────
    private class TextFilter { public string Label { get; init; } = ""; public string Value { get; set; } = ""; }

    private List<TextFilter> _textFilters = new()
    {
        new() { Label = "Name"               },
        new() { Label = "Surname"            },
        new() { Label = "Identifier"         },
        new() { Label = "Email Address"      },
        new() { Label = "Local Municipality" },
        new() { Label = "Host Company"       },
        new() { Label = "Lead Company"       },
        new() { Label = "Contact Details"    },
    };

    // ── Dropdown filters ─────────────────────────────────────────────────────
    private string _filterSex         = string.Empty;
    private string _filterStatus      = string.Empty;
    private string _filterDemographic = string.Empty;
    private string _filterJobType     = string.Empty;
    private string _filterDisability  = string.Empty;

    private List<string> _sexOptions         = new();
    private List<string> _statusOptions      = new();
    private List<string> _demographicOptions = new();
    private List<string> _jobTypeOptions     = new();

    // ── Filter helpers ────────────────────────────────────────────────────────
    private bool HasActiveFilters =>
        !string.IsNullOrWhiteSpace(_globalSearch) ||
        _textFilters.Any(f => !string.IsNullOrWhiteSpace(f.Value)) ||
        !string.IsNullOrWhiteSpace(_filterSex)         ||
        !string.IsNullOrWhiteSpace(_filterStatus)      ||
        !string.IsNullOrWhiteSpace(_filterDemographic) ||
        !string.IsNullOrWhiteSpace(_filterJobType)     ||
        !string.IsNullOrWhiteSpace(_filterDisability);

    private int ActiveFilterCount
    {
        get
        {
            int c = string.IsNullOrWhiteSpace(_globalSearch) ? 0 : 1;
            c += _textFilters.Count(f => !string.IsNullOrWhiteSpace(f.Value));
            if (!string.IsNullOrWhiteSpace(_filterSex))         c++;
            if (!string.IsNullOrWhiteSpace(_filterStatus))      c++;
            if (!string.IsNullOrWhiteSpace(_filterDemographic)) c++;
            if (!string.IsNullOrWhiteSpace(_filterJobType))     c++;
            if (!string.IsNullOrWhiteSpace(_filterDisability))  c++;
            return c;
        }
    }

    // ── Dialog ────────────────────────────────────────────────────────────────
    private bool _showDialog;
    private bool _isNewRecord;
    private PersonRecord? _editingRecord;

    // ── Lifecycle ─────────────────────────────────────────────────────────────
    protected override void OnInitialized()
    {
        DataService.OnDataChanged += Refresh;
        Refresh();
    }
    public void Dispose() => DataService.OnDataChanged -= Refresh;

    private void Refresh()
    {
        BuildDropdowns();
        ApplyFilters();
        InvokeAsync(StateHasChanged);
    }

    private void BuildDropdowns()
    {
        var all = DataService.GetRecords();
        _sexOptions         = all.Select(r => r.Sex).Where(s => !string.IsNullOrWhiteSpace(s)).Distinct().OrderBy(x => x).ToList();
        _statusOptions      = all.Select(r => r.EmploymentStatus).Where(s => !string.IsNullOrWhiteSpace(s)).Distinct().OrderBy(x => x).ToList();
        _demographicOptions = all.Select(r => r.DemographicGroup).Where(s => !string.IsNullOrWhiteSpace(s)).Distinct().OrderBy(x => x).ToList();
        _jobTypeOptions     = all.Select(r => r.JobType).Where(s => !string.IsNullOrWhiteSpace(s)).Distinct().OrderBy(x => x).ToList();
    }

    private void ToggleFilters() => _showFilters = !_showFilters;

    private void OnTextFilterChanged(TextFilter filter, string value)
    {
        filter.Value = value;
        ApplyFilters();
    }

    private void ClearTextField(TextFilter filter)
    {
        filter.Value = string.Empty;
        ApplyFilters();
    }

    private void OnSexFilterChanged(string v)         { _filterSex         = v ?? string.Empty; ApplyFilters(); }
    private void OnStatusFilterChanged(string v)      { _filterStatus      = v ?? string.Empty; ApplyFilters(); }
    private void OnDemographicFilterChanged(string v) { _filterDemographic = v ?? string.Empty; ApplyFilters(); }
    private void OnJobTypeFilterChanged(string v)     { _filterJobType     = v ?? string.Empty; ApplyFilters(); }
    private void OnDisabilityFilterChanged(string v)  { _filterDisability  = v ?? string.Empty; ApplyFilters(); }

    private void ApplyFilters()
    {
        var q = DataService.GetRecords().AsEnumerable();

        if (!string.IsNullOrWhiteSpace(_globalSearch))
        {
            var t = _globalSearch.Trim();
            q = q.Where(r =>
                CI(r.Name, t)              || CI(r.Surname, t)           || CI(r.Identifier, t)      ||
                CI(r.EmailAddress, t)      || CI(r.LocalMunicipality, t) || CI(r.HostCompany, t)     ||
                CI(r.LeadCompany, t)       || CI(r.JobType, t)           || CI(r.DemographicGroup, t)||
                CI(r.Sex, t)               || CI(r.ContactDetails, t)    ||
                CI(r.EmploymentStatus, t)  || CI(r.PersonDisability, t));
        }

        foreach (var f in _textFilters.Where(f => !string.IsNullOrWhiteSpace(f.Value)))
        {
            var term = f.Value.Trim();
            q = f.Label switch
            {
                "Name"               => q.Where(r => CI(r.Name, term)),
                "Surname"            => q.Where(r => CI(r.Surname, term)),
                "Identifier"         => q.Where(r => CI(r.Identifier, term)),
                "Email Address"      => q.Where(r => CI(r.EmailAddress, term)),
                "Local Municipality" => q.Where(r => CI(r.LocalMunicipality, term)),
                "Host Company"       => q.Where(r => CI(r.HostCompany, term)),
                "Lead Company"       => q.Where(r => CI(r.LeadCompany, term)),
                "Contact Details"    => q.Where(r => CI(r.ContactDetails, term)),
                _                    => q
            };
        }

        if (!string.IsNullOrWhiteSpace(_filterSex))
            q = q.Where(r => r.Sex.Equals(_filterSex, StringComparison.OrdinalIgnoreCase));
        if (!string.IsNullOrWhiteSpace(_filterStatus))
            q = q.Where(r => r.EmploymentStatus.Equals(_filterStatus, StringComparison.OrdinalIgnoreCase));
        if (!string.IsNullOrWhiteSpace(_filterDemographic))
            q = q.Where(r => r.DemographicGroup.Equals(_filterDemographic, StringComparison.OrdinalIgnoreCase));
        if (!string.IsNullOrWhiteSpace(_filterJobType))
            q = q.Where(r => r.JobType.Equals(_filterJobType, StringComparison.OrdinalIgnoreCase));
        if (!string.IsNullOrWhiteSpace(_filterDisability))
        {
            bool wantDisabled = _filterDisability == "yes";
            q = q.Where(r => r.HasDisability == wantDisabled);
        }

        _displayedRecords = q.ToList();
    }

    private static bool CI(string src, string term) =>
        src.Contains(term, StringComparison.OrdinalIgnoreCase);

    private void ClearAllFilters()
    {
        _globalSearch = string.Empty;
        foreach (var f in _textFilters) f.Value = string.Empty;
        _filterSex = _filterStatus = _filterDemographic = _filterJobType = _filterDisability = string.Empty;
        ApplyFilters();
    }

    // ── Drag & Drop ──────────────────────────────────────────────────────────
    private void OnDragEnter(DragEventArgs _) => _isDragging = true;
    private void OnDragLeave(DragEventArgs _) => _isDragging = false;
    private void OnDrop(DragEventArgs _)
    {
        _isDragging = false;
        Snackbar.Add("Please use the Browse button to select your file.", Severity.Info);
    }

    private async Task HandleFileChanged(IBrowserFile? file)
    {
        if (file is null) return;
        _selectedFileName = null;
        _importedCount = 0;
        _validationErrors.Clear();
        _isLoading = true;
        StateHasChanged();

        try
        {
            var ext = Path.GetExtension(file.Name).ToLowerInvariant();
            if (ext != ".xlsx" && ext != ".xls")
            {
                Snackbar.Add("Only .xlsx and .xls files are supported.", Severity.Error);
                return;
            }

            using var stream = file.OpenReadStream(maxAllowedSize: 20 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            ms.Position = 0;

            var (count, missing) = await DataService.ImportFromExcelAsync(ms);

            if (missing.Any())
            {
                _validationErrors = missing;
                Snackbar.Add($"Import failed: missing columns — {string.Join(", ", missing)}", Severity.Error);
                return;
            }

            _selectedFileName = file.Name;
            _importedCount = count;

            if (count == 0)
                Snackbar.Add("No data rows found in the file. Check the file has data below the header row.", Severity.Warning);
            else
                Snackbar.Add($"✓ Imported {count} records from {file.Name}", Severity.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Upload error");
            Snackbar.Add($"Import failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    // ── Template Download ─────────────────────────────────────────────────────
    private async Task DownloadTemplate()
    {
        try
        {
            var bytes     = DataService.GenerateTemplate();
            var byteArray = bytes.Select(b => (int)b).ToArray();
            await JS.InvokeVoidAsync("downloadFileFromBytes",
                "ParticipantTemplate.xlsx",
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                byteArray);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Template download error");
            Snackbar.Add("Failed to generate template.", Severity.Error);
        }
    }

    // ── CRUD ─────────────────────────────────────────────────────────────────
    private void OpenAddDialog()
    {
        _editingRecord = new PersonRecord();
        _isNewRecord   = true;
        _showDialog    = true;
    }

    private void OpenEditDialog(PersonRecord r)
    {
        _editingRecord = new PersonRecord
        {
            RowNumber         = r.RowNumber,        Name              = r.Name,
            Surname           = r.Surname,          Identifier        = r.Identifier,
            EmailAddress      = r.EmailAddress,     LocalMunicipality = r.LocalMunicipality,
            HostCompany       = r.HostCompany,      LeadCompany       = r.LeadCompany,
            JobType           = r.JobType,          DemographicGroup  = r.DemographicGroup,
            Sex               = r.Sex,              ContactDetails    = r.ContactDetails,
            EmploymentStatus  = r.EmploymentStatus, PersonDisability  = r.PersonDisability
        };
        _isNewRecord = false;
        _showDialog  = true;
    }

    private void SaveRecord()
    {
        if (_editingRecord is null) return;
        if (_isNewRecord) { DataService.AddRecord(_editingRecord);   Snackbar.Add("Record added.",   Severity.Success); }
        else              { DataService.UpdateRecord(_editingRecord); Snackbar.Add("Record updated.", Severity.Success); }
        CloseDialog();
    }

    private void CloseDialog() { _showDialog = false; _editingRecord = null; }

    private async Task ConfirmDelete(PersonRecord r)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Delete", $"Delete record for {r.FullName}?",
            yesText: "Delete", cancelText: "Cancel");
        if (result == true)
        {
            DataService.DeleteRecord(r.RowNumber);
            Snackbar.Add($"Deleted {r.FullName}.", Severity.Info);
        }
    }

    // ── Export ────────────────────────────────────────────────────────────────
    private async Task ExportData(bool allData)
    {
        try
        {
            var records   = allData ? DataService.GetRecords() : _displayedRecords;
            var bytes     = DataService.ExportToExcel(records);
            var fileName  = $"Participants_{(allData ? "All" : "Filtered")}_{DateTime.Now:yyyyMMdd_HHmm}.xlsx";
            var byteArray = bytes.Select(b => (int)b).ToArray();
            await JS.InvokeVoidAsync("downloadFileFromBytes", fileName,
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", byteArray);
            Snackbar.Add($"Exported {records.Count} records.", Severity.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Export error");
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
    }
}
