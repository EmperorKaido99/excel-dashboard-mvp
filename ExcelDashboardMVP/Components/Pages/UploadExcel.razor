@page "/upload"
@using ExcelDashboardMVP.Services
@using ExcelDashboardMVP.Models
@inject ExcelDataService ExcelDataService
@inject ISnackbar Snackbar
@inject ILogger<UploadExcel> Logger

<PageTitle>Upload Excel</PageTitle>

<!-- ── Upload card ──────────────────────────────────────────── -->
<MudPaper Elevation="2" Class="pa-6 ma-4" Style="max-width: 680px;">
    <MudText Typo="Typo.h5" Color="Color.Primary" GutterBottom>Upload Excel File</MudText>
    <MudText Color="Color.Secondary" Class="mb-4">
        Select a <strong>.xlsx</strong> file to import person records into the system.
    </MudText>

    <!-- MudBlazor 8: ActivatorContent replaces the old ButtonTemplate.
         The Context exposes the hidden input's id so the label can
         wire up via the "for" attribute automatically. -->
    <MudFileUpload T="IBrowserFile"
                   FilesChanged="HandleFileChanged"
                   Accept=".xlsx"
                   Disabled="isLoading">
        <ActivatorContent>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.FileUpload"
                       HtmlTag="label"
                       for="@context.Id">
                Pick file
            </MudButton>
        </ActivatorContent>
    </MudFileUpload>

    <!-- file-name badge shown after a file is picked ----------- -->
    @if (selectedFileName != null)
    {
        <MudChip T="string"
                 Color="Color.Info"
                 Icon="@Icons.Material.Filled.Description"
                 Class="mt-3">
            @selectedFileName
        </MudChip>
    }

    <!-- loading spinner ---------------------------------------- -->
    @if (isLoading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate Class="mt-4" />
        <MudText Color="Color.Secondary" Class="mt-2">Parsing file…</MudText>
    }
</MudPaper>

<!-- ── Summary card (only visible after a successful import) ── -->
@if (importedCount > 0)
{
    <MudPaper Elevation="2" Class="pa-6 ma-4" Style="max-width: 680px;">
        <MudText Typo="Typo.h6" Color="Color.Success" GutterBottom>
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" /> Import Summary
        </MudText>

        <MudDivider Class="mb-3" />

        <MudGrid Spacing="2">
            <MudItem xs="6">
                <MudText><strong>Records imported</strong></MudText>
                <MudText Typo="Typo.h4" Color="Color.Primary">@importedCount</MudText>
            </MudItem>
            <MudItem xs="6">
                <MudText><strong>Source file</strong></MudText>
                <MudText>@selectedFileName</MudText>
            </MudItem>
        </MudGrid>

        <MudButton Variant="Variant.Contained"
                   Color="Color.Secondary"
                   StartIcon="@Icons.Material.Filled.TableView"
                   Class="mt-4"
                   Href="/dashboard">
            View Dashboard
        </MudButton>
    </MudPaper>
}

<!-- ── Quick-preview table (first 10 rows) ─────────────────── -->
@if (previewRecords != null && previewRecords.Any())
{
    <MudPaper Elevation="2" Class="pa-4 ma-4">
        <MudText Typo="Typo.h6" GutterBottom>Preview (first 10 rows)</MudText>

        <MudSimpleTable Dense Hover Striped>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Surname</th>
                    <th>Age</th>
                    <th>Municipality</th>
                    <th>Host Company</th>
                    <th>Start Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var rec in previewRecords)
                {
                    <tr>
                        <td>@rec.Number</td>
                        <td>@rec.Name</td>
                        <td>@rec.Surname</td>
                        <td>@rec.Age</td>
                        <td>@rec.LocalMunicipality</td>
                        <td>@rec.HostCompany</td>
                        <td>@(rec.StartDate?.ToString("yyyy-MM-dd") ?? "—")</td>
                        <td>
                            @if (rec.IsActivePlacement)
                            {
                                <MudChip T="string" Color="Color.Success" Size="Size.Small">Active</MudChip>
                            }
                            else
                            {
                                <MudChip T="string" Color="Color.Default" Size="Size.Small">Inactive</MudChip>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </MudSimpleTable>
    </MudPaper>
}

<!-- ── @code block ─────────────────────────────────────────── -->
@code {
    private bool isLoading;
    private string? selectedFileName;
    private int importedCount;
    private List<PersonRecord>? previewRecords;

    // MudBlazor 8 MudFileUpload fires FilesChanged with the file
    // directly (not wrapped in an EventArgs).
    private async Task HandleFileChanged(IBrowserFile? file)
    {
        // Reset previous state
        selectedFileName = null;
        importedCount    = 0;
        previewRecords   = null;
        isLoading        = true;

        try
        {
            // ── basic validation ────────────────────────────────
            if (file == null)
            {
                Snackbar.Add("No file was selected.", Severity.Warning);
                return;
            }

            var ext = Path.GetExtension(file.Name).ToLowerInvariant();
            if (ext != ".xlsx")
            {
                Snackbar.Add("Only .xlsx files are supported.", Severity.Error);
                return;
            }

            selectedFileName = file.Name;

            // ── stream the file into a MemoryStream ─────────────
            using var browserStream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10 MB
            using var memoryStream  = new MemoryStream();
            await browserStream.CopyToAsync(memoryStream);
            memoryStream.Position = 0;

            // ── hand off to the singleton service ───────────────
            importedCount = await ExcelDataService.ImportFromExcelAsync(memoryStream);

            if (importedCount == 0)
            {
                Snackbar.Add("The file contained no data rows.", Severity.Warning);
                return;
            }

            // ── grab up to 10 rows for the on-page preview ─────
            previewRecords = ExcelDataService.GetRecords().Take(10).ToList();

            Snackbar.Add(
                $"Successfully imported {importedCount} record{(importedCount == 1 ? "" : "s")} from {file.Name}.",
                Severity.Success,
                configure => { configure.ShowCloseIcon = true; });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error while uploading/parsing Excel file.");
            Snackbar.Add($"Import failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }
}
