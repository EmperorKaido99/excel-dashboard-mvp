@page "/upload"
@rendermode InteractiveServer
@using ExcelDashboardMVP.Services
@using ExcelDashboardMVP.Models
@inject ExcelDataService ExcelDataService
@inject ISnackbar Snackbar
@inject ILogger<UploadExcel> Logger
@inject Microsoft.JSInterop.IJSRuntime JS

<PageTitle>Upload Excel</PageTitle>

<MudPaper Elevation="2" Class="pa-6 ma-4" Style="max-width:680px;">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
        <MudText Typo="Typo.h5" Color="Color.Primary">Upload Excel File</MudText>
        <MudButton StartIcon="@Icons.Material.Filled.Download"
                   Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Small"
                   OnClick="DownloadTemplate">
            Download Template
        </MudButton>
    </MudStack>
    <MudText Color="Color.Secondary" Class="mb-4">
        Select a <strong>.xlsx</strong> or <strong>.xls</strong> file to import participant records.
        Data is instantly available across all dashboard pages after upload.
    </MudText>

    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-3">
        Expected columns (any order): Name · Surname · Identifier · EmailAddress ·
        LocalMunicipality · HostCompany · LeadCompany · JobType · DemographicGroup ·
        Sex · ContactDetails · EmploymentStatus · PersonDisability
    </MudText>

    <MudFileUpload T="IBrowserFile" FilesChanged="HandleFileChanged"
                   Accept=".xlsx,.xls" Disabled="_isLoading">
        <ActivatorContent>
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.FileUpload">
                Pick file
            </MudButton>
        </ActivatorContent>
    </MudFileUpload>

    @if (_selectedFileName != null)
    {
        <MudChip T="string" Color="Color.Info"
                 Icon="@Icons.Material.Filled.Description" Class="mt-3">
            @_selectedFileName
        </MudChip>
    }

    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-4" />
        <MudText Color="Color.Secondary" Class="mt-2">Parsing file…</MudText>
    }

    @if (_validationErrors.Any())
    {
        <MudAlert Severity="Severity.Error" Class="mt-3" Dense="true" ShowCloseIcon="true"
                  CloseIconClicked="() => _validationErrors.Clear()">
            <strong>Missing required columns:</strong> @string.Join(", ", _validationErrors)
            <br />
            <MudText Typo="Typo.caption">
                Download the template to see the expected column names.
            </MudText>
        </MudAlert>
    }
</MudPaper>

@if (_importedCount > 0)
{
    <MudPaper Elevation="2" Class="pa-6 ma-4" Style="max-width:680px;">
        <MudText Typo="Typo.h6" Color="Color.Success">
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
            Import Summary
        </MudText>
        <MudDivider Class="mb-3" />
        <MudGrid Spacing="2">
            <MudItem xs="6">
                <MudText><strong>Records imported</strong></MudText>
                <MudText Typo="Typo.h4" Color="Color.Primary">@_importedCount</MudText>
            </MudItem>
            <MudItem xs="6">
                <MudText><strong>Source file</strong></MudText>
                <MudText>@_selectedFileName</MudText>
            </MudItem>
        </MudGrid>
        <MudStack Row="true" Spacing="2" Class="mt-4">
            <MudButton Variant="Variant.Filled" Color="Color.Secondary"
                       StartIcon="@Icons.Material.Filled.TableView" Href="/data-table">
                View Data Table
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Dashboard" Href="/dashboard/projects">
                View Dashboard
            </MudButton>
        </MudStack>
    </MudPaper>
}

@if (_previewRecords != null && _previewRecords.Any())
{
    <MudPaper Elevation="2" Class="pa-4 ma-4">
        <MudText Typo="Typo.h6">Preview (first 10 rows)</MudText>
        <MudSimpleTable Dense="true" Hover="true" Striped="true">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Surname</th>
                    <th>Municipality</th>
                    <th>Host Company</th>
                    <th>Job Type</th>
                    <th>Demographic</th>
                    <th>Sex</th>
                    <th>Emp. Status</th>
                    <th>Disability</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var rec in _previewRecords)
                {
                    <tr>
                        <td>@rec.RowNumber</td>
                        <td>@rec.Name</td>
                        <td>@rec.Surname</td>
                        <td>@rec.LocalMunicipality</td>
                        <td>@rec.HostCompany</td>
                        <td>@rec.JobType</td>
                        <td>@rec.DemographicGroup</td>
                        <td>@rec.Sex</td>
                        <td>@rec.EmploymentStatus</td>
                        <td>
                            @if (rec.HasDisability)
                            {
                                <MudChip T="string" Color="Color.Warning" Size="Size.Small">Yes</MudChip>
                            }
                            else
                            {
                                <MudChip T="string" Color="Color.Default" Size="Size.Small">
                                    @(string.IsNullOrWhiteSpace(rec.PersonDisability) ? "—" : rec.PersonDisability)
                                </MudChip>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </MudSimpleTable>
    </MudPaper>
}

@code {
    private bool _isLoading;
    private string? _selectedFileName;
    private int _importedCount;
    private List<PersonRecord>? _previewRecords;
    private List<string> _validationErrors = new();

    private async Task HandleFileChanged(IBrowserFile? file)
    {
        _selectedFileName  = null;
        _importedCount     = 0;
        _previewRecords    = null;
        _validationErrors.Clear();
        _isLoading = true;

        try
        {
            if (file == null)
            {
                Snackbar.Add("No file was selected.", Severity.Warning);
                return;
            }

            var ext = Path.GetExtension(file.Name).ToLowerInvariant();
            if (ext != ".xlsx" && ext != ".xls")
            {
                Snackbar.Add("Only .xlsx and .xls files are supported.", Severity.Error);
                return;
            }

            _selectedFileName = file.Name;

            using var browserStream = file.OpenReadStream(maxAllowedSize: 20 * 1024 * 1024);
            using var ms = new MemoryStream();
            await browserStream.CopyToAsync(ms);
            ms.Position = 0;

            var (count, missing) = await ExcelDataService.ImportFromExcelAsync(ms);

            if (missing.Any())
            {
                _validationErrors = missing;
                Snackbar.Add($"Import failed — missing columns: {string.Join(", ", missing)}", Severity.Error);
                return;
            }

            _importedCount = count;

            if (count == 0)
            {
                Snackbar.Add("The file contained no data rows.", Severity.Warning);
                return;
            }

            _previewRecords = ExcelDataService.GetRecords().Take(10).ToList();

            Snackbar.Add(
                $"Imported {count} record{(count == 1 ? "" : "s")} from {file.Name}.",
                Severity.Success,
                cfg => { cfg.ShowCloseIcon = true; cfg.VisibleStateDuration = 6000; });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error while uploading/parsing Excel file.");
            Snackbar.Add($"Import failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task DownloadTemplate()
    {
        try
        {
            var bytes     = ExcelDataService.GenerateTemplate();
            var byteArray = bytes.Select(b => (int)b).ToArray();
            await JS.InvokeVoidAsync("downloadFileFromBytes",
                "ParticipantTemplate.xlsx",
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                byteArray);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Template download error");
            Snackbar.Add("Failed to generate template.", Severity.Error);
        }
    }
}
