@page "/dashboard/projects"
@rendermode InteractiveServer
@using ExcelDashboardMVP.Models
@using ExcelDashboardMVP.Services
@inject ExcelDataService ExcelDataService
@implements IDisposable

<PageTitle>Projects Dashboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudGrid Class="mb-4">
        <MudItem xs="12">
            <MudText Typo="Typo.h4" Color="Color.Primary">Projects</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                @_records.Count participants · Project Phoenix (Cohort 1–4) &amp; Project Lotus (Cohort 5)
            </MudText>
        </MudItem>
    </MudGrid>

    @* ── Metric Cards ─────────────────────────────────────────────────────── *@
    <MudGrid Spacing="3" Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row="true" AlignItems="AlignItems.Start"
                              Justify="Justify.SpaceBetween">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Total Participants
                            </MudText>
                            <MudText Typo="Typo.h4">@_records.Count</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Success"
                                     Icon="@Icons.Material.Filled.People">
                                In database
                            </MudChip>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.Folder"
                                 Color="Color.Primary" Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row="true" AlignItems="AlignItems.Start"
                              Justify="Justify.SpaceBetween">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Host Companies
                            </MudText>
                            <MudText Typo="Typo.h4">@_hostCompanyCount</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Info"
                                     Icon="@Icons.Material.Filled.Business">
                                Unique hosts
                            </MudChip>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.Business"
                                 Color="Color.Info" Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row="true" AlignItems="AlignItems.Start"
                              Justify="Justify.SpaceBetween">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Municipalities
                            </MudText>
                            <MudText Typo="Typo.h4">@_municipalityCount</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Success"
                                     Icon="@Icons.Material.Filled.LocationCity">
                                Unique areas
                            </MudChip>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.Map"
                                 Color="Color.Success" Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row="true" AlignItems="AlignItems.Start"
                              Justify="Justify.SpaceBetween">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Job Types
                            </MudText>
                            <MudText Typo="Typo.h4">@_jobTypeCount</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning"
                                     Icon="@Icons.Material.Filled.Work">
                                Categories
                            </MudChip>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.Work"
                                 Color="Color.Warning" Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    @* ── Main Layout ─────────────────────────────────────────────────────── *@
    <MudGrid Spacing="3">

        @* ── Left: Chart + Participants Table ──────────────────────────── *@
        <MudItem xs="12" md="8">

            <MudCard Elevation="2" Class="mb-3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Placement Analysis</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudChart ChartType="ChartType.Bar"
                              ChartSeries="@_chartData"
                              XAxisLabels="@_chartLabels"
                              Width="100%" Height="250px"
                              ChartOptions="@_chartOptions" />
                </MudCardContent>
            </MudCard>

            <MudCard Elevation="2">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Participants Summary</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudTextField @bind-Value="_searchString"
                                      Placeholder="Search…"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      IconSize="Size.Small"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Immediate="true"
                                      DebounceInterval="200" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent Class="pa-0">
                    <MudTable Items="@GetFiltered()"
                              Hover="true" Dense="true"
                              FixedHeader="true" Height="400px">
                        <HeaderContent>
                            <MudTh>#</MudTh>
                            <MudTh>Name</MudTh>
                            <MudTh>Host Company</MudTh>
                            <MudTh>Job Type</MudTh>
                            <MudTh>Municipality</MudTh>
                            <MudTh>Status</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.RowNumber</MudTd>
                            <MudTd>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudAvatar Color="Color.Primary" Size="Size.Small">
                                        @(context.Name.Length > 0 ? context.Name[0].ToString() : "?")
                                    </MudAvatar>
                                    @context.FullName
                                </MudStack>
                            </MudTd>
                            <MudTd>@context.HostCompany</MudTd>
                            <MudTd>@context.JobType</MudTd>
                            <MudTd>@context.LocalMunicipality</MudTd>
                            <MudTd>
                                <MudChip T="string" Size="Size.Small"
                                         Color="@GetStatusColor(context.EmploymentStatus)">
                                    @(string.IsNullOrWhiteSpace(context.EmploymentStatus)
                                        ? "Unknown" : context.EmploymentStatus)
                                </MudChip>
                            </MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText Align="Align.Center" Color="Color.Secondary" Class="pa-4">
                                No data — upload an Excel file via Data Table.
                            </MudText>
                        </NoRecordsContent>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>

        @* ── Right: Team + Projects + Sponsors ──────────────────────────── *@
        <MudItem xs="12" md="4">

            <MudCard Elevation="2" Class="mb-3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Team Members</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @foreach (var m in _teamMembers)
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center"
                                  Justify="Justify.SpaceBetween" Class="mb-3">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudAvatar Color="@m.AvatarColor" Size="Size.Medium">
                                    @m.Initial
                                </MudAvatar>
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2">@m.Name</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @m.Role
                                    </MudText>
                                </MudStack>
                            </MudStack>
                        </MudStack>
                    }
                </MudCardContent>
            </MudCard>

            <MudCard Elevation="2" Class="mb-3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Projects</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="2">
                        <MudCard Outlined="true">
                            <MudCardContent>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.Rocket" Color="Color.Primary" />
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body1">Project Phoenix</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            Cohort 1 – 4
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                        <MudCard Outlined="true">
                            <MudCardContent>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.LocalFlorist"
                                             Color="Color.Secondary" />
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body1">Project Lotus</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            Cohort 5
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    </MudStack>
                </MudCardContent>
            </MudCard>

            <MudCard Elevation="2">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Sponsors</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Row="true" Spacing="1" Style="flex-wrap:wrap; gap:8px;">
                        @foreach (var s in _sponsors)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary"
                                     Icon="@Icons.Material.Filled.Star">
                                @s
                            </MudChip>
                        }
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    @* ── Host Company breakdown ──────────────────────────────────────────── *@
    @if (_records.Any())
    {
        <MudCard Elevation="2" Class="mt-3">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Participants by Host Company</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @foreach (var grp in _records
                    .GroupBy(r => r.HostCompany)
                    .Where(g => !string.IsNullOrWhiteSpace(g.Key))
                    .OrderByDescending(g => g.Count()).Take(10))
                {
                    var pct = _records.Count > 0
                        ? (double)grp.Count() / _records.Count * 100 : 0;
                    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2" Spacing="3">
                        <MudText Typo="Typo.body2" Style="min-width:180px; white-space:nowrap;
                                                           overflow:hidden; text-overflow:ellipsis;">
                            @grp.Key
                        </MudText>
                        <MudProgressLinear Value="@pct" Color="Color.Primary"
                                           Size="Size.Medium" Style="flex:1;" Rounded="true" />
                        <MudText Typo="Typo.caption" Color="Color.Secondary"
                                 Style="min-width:40px; text-align:right;">
                            @grp.Count()
                        </MudText>
                    </MudStack>
                }
            </MudCardContent>
        </MudCard>
    }
</MudContainer>

@code {
    private List<PersonRecord> _records = new();
    private string _searchString = "";

    private int _hostCompanyCount;
    private int _municipalityCount;
    private int _jobTypeCount;

    private List<ChartSeries> _chartData    = new();
    private string[]          _chartLabels  = Array.Empty<string>();
    private ChartOptions      _chartOptions = new() { YAxisTicks = 5, MaxNumYAxisTicks = 5 };

    // ── Hardcoded data ──────────────────────────────────────────────────────
    private record TeamMember(string Name, string Role, string Initial, Color AvatarColor);

    private readonly List<TeamMember> _teamMembers = new()
    {
        new("Amber Dunjwa",      "Admin · PA · AI Content Development", "A", Color.Primary),
        new("Sibusiso Skhosana", "Facilitation · Recruitment",          "S", Color.Secondary),
        new("Chulumanco Mbete",  "Platform Admin",                      "C", Color.Info),
        new("Jessey Foster",     "AI Content Development",              "J", Color.Success),
        new("Jordan Philips",    "AI Content Development",              "J", Color.Warning),
        new("Rayhaan Arendse",   "Cloud Admin · AI Content Dev",        "R", Color.Error),
        new("Naeemah Adams",     "Main Admin",                          "N", Color.Primary),
        new("Mary",              "Senior Manager",                      "M", Color.Info),
        new("Judy",              "Director",                            "J", Color.Secondary),
        new("Magda",             "Consultant",                          "M", Color.Success),
    };

    private readonly List<string> _sponsors = new()
    {
        "Collective X", "YES", "DEDAT", "Excellerate CPT"
    };

    // ── Lifecycle ───────────────────────────────────────────────────────────
    protected override void OnInitialized()
    {
        ExcelDataService.OnDataChanged += Reload;
        LoadData();
    }

    private void Reload() { LoadData(); InvokeAsync(StateHasChanged); }
    public void Dispose() => ExcelDataService.OnDataChanged -= Reload;

    private void LoadData()
    {
        _records          = ExcelDataService.GetRecords();
        _hostCompanyCount = _records.Select(r => r.HostCompany)
                                    .Where(s => !string.IsNullOrWhiteSpace(s))
                                    .Distinct().Count();
        _municipalityCount = _records.Select(r => r.LocalMunicipality)
                                     .Where(s => !string.IsNullOrWhiteSpace(s))
                                     .Distinct().Count();
        _jobTypeCount     = _records.Select(r => r.JobType)
                                    .Where(s => !string.IsNullOrWhiteSpace(s))
                                    .Distinct().Count();
        BuildChart();
    }

    private void BuildChart()
    {
        var groups = _records
            .GroupBy(r => r.JobType)
            .Where(g => !string.IsNullOrWhiteSpace(g.Key))
            .OrderByDescending(g => g.Count())
            .Take(7).ToList();

        _chartLabels = groups.Select(g => g.Key.Length > 12
            ? g.Key[..12] + "…" : g.Key).ToArray();
        _chartData = new List<ChartSeries>
        {
            new() { Name = "Participants", Data = groups.Select(g => (double)g.Count()).ToArray() }
        };
    }

    private List<PersonRecord> GetFiltered()
    {
        var q = _records.AsEnumerable();
        if (!string.IsNullOrWhiteSpace(_searchString))
            q = q.Where(r =>
                r.FullName.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
                r.HostCompany.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
                r.JobType.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
                r.LocalMunicipality.Contains(_searchString, StringComparison.OrdinalIgnoreCase));
        return q.Take(50).ToList();
    }

    private Color GetStatusColor(string status) => status?.ToLowerInvariant() switch
    {
        var s when s?.Contains("employed") == true => Color.Success,
        var s when s?.Contains("unemployed") == true => Color.Error,
        var s when s?.Contains("student") == true => Color.Info,
        _ => Color.Default
    };
}
