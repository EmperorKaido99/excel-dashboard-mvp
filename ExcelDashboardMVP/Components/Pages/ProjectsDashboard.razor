@page "/dashboard/projects"
@using ExcelDashboardMVP.Models
@using ExcelDashboardMVP.Services
@inject ExcelDataService ExcelDataService
@implements IDisposable

<PageTitle>Projects Dashboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <!-- Page Header — NO BUTTONS -->
    <MudGrid Class="mb-4">
        <MudItem xs="12">
            <MudText Typo="Typo.h4" Color="Color.Primary">Projects</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                @_records.Count participants loaded
            </MudText>
        </MudItem>
    </MudGrid>

    <!-- Top Metrics Cards -->
    <MudGrid Spacing="3" Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row AlignItems="AlignItems.Start" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Completed Placements</MudText>
                            <MudText Typo="Typo.h4">@_completedCount</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.TrendingUp">
                                Active in system
                            </MudChip>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Primary" Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row AlignItems="AlignItems.Start" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Active Placements</MudText>
                            <MudText Typo="Typo.h4">@_activeCount</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.Circle">
                                Currently placed
                            </MudChip>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.Work" Color="Color.Info" Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row AlignItems="AlignItems.Start" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Total Participants</MudText>
                            <MudText Typo="Typo.h4">@_records.Count</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.People">
                                In database
                            </MudChip>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.Folder" Color="Color.Success" Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row AlignItems="AlignItems.Start" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Host Companies</MudText>
                            <MudText Typo="Typo.h4">@_hostCompanyCount</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.Business">
                                Unique hosts
                            </MudChip>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" Color="Color.Warning" Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Main Content Grid -->
    <MudGrid Spacing="3">
        <!-- Left Column -->
        <MudItem xs="12" md="8">
            <!-- Project Analysis Chart -->
            <MudCard Elevation="2" Class="mb-3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Placement Analysis</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudChart ChartType="ChartType.Bar"
                              ChartSeries="@_projectAnalysisData"
                              XAxisLabels="@_daysOfWeek"
                              Width="100%"
                              Height="250px"
                              ChartOptions="@_chartOptions" />
                </MudCardContent>
            </MudCard>

            <!-- Projects Summary Table -->
            <MudCard Elevation="2">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Participants Summary</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudTextField @bind-Value="_searchString"
                                      Placeholder="Search…"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      IconSize="Size.Small"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Immediate="true"
                                      DebounceInterval="200" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent Class="pa-0">
                    <MudTable Items="@GetFilteredProjects()"
                              Hover="true"
                              Dense="true"
                              FixedHeader="true"
                              Height="400px">
                        <HeaderContent>
                            <MudTh>No</MudTh>
                            <MudTh>Name</MudTh>
                            <MudTh>Assigned To</MudTh>
                            <MudTh>Progress</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh>End Date</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="No">@context.Number</MudTd>
                            <MudTd DataLabel="Name">@context.HostCompany</MudTd>
                            <MudTd DataLabel="Assigned To">
                                <MudAvatarGroup Max="2" Spacing="2">
                                    <MudAvatar Color="Color.Primary" Size="Size.Small">@context.Name.Substring(0, 1)</MudAvatar>
                                    <MudAvatar Color="Color.Secondary" Size="Size.Small">@context.Surname.Substring(0, 1)</MudAvatar>
                                </MudAvatarGroup>
                            </MudTd>
                            <MudTd DataLabel="Progress">
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                    <MudProgressLinear Color="@GetProgressColor(context.PeriodOfPlacement)"
                                                       Value="@context.PeriodOfPlacement"
                                                       Size="Size.Small"
                                                       Style="width: 80px;" />
                                    <MudText Typo="Typo.caption">@context.PeriodOfPlacement%</MudText>
                                </MudStack>
                            </MudTd>
                            <MudTd DataLabel="Status">
                                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context)">
                                    @GetStatusText(context)
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="End Date">@context.EndDate?.ToString("dd-MM-yyyy")</MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText Align="Align.Center" Color="Color.Secondary" Class="pa-4">
                                No data — upload an Excel file via Uploads.
                            </MudText>
                        </NoRecordsContent>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Right Column -->
        <MudItem xs="12" md="4">
            <!-- Team Members -->
            <MudCard Elevation="2" Class="mb-3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Team Members</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (!_records.Any())
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No data yet.</MudText>
                    }
                    @foreach (var member in _records.Take(5))
                    {
                        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudAvatar Color="Color.Primary">@member.Name.Substring(0, 1)</MudAvatar>
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2">@member.FullName</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@member.JobType</MudText>
                                </MudStack>
                            </MudStack>
                            @if (member.IsActivePlacement)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Circle" Color="Color.Success" Size="Size.Small" />
                            }
                        </MudStack>
                    }
                </MudCardContent>
            </MudCard>

            <!-- Demographics -->
            <MudCard Elevation="2" Class="mb-3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Demographics</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @foreach (var grp in _records.GroupBy(r => r.Sex).Take(5))
                    {
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudText Typo="Typo.body2">@(string.IsNullOrWhiteSpace(grp.Key) ? "Unknown" : grp.Key)</MudText>
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudProgressLinear Value="@((_records.Count > 0 ? (double)grp.Count() / _records.Count * 100 : 0))"
                                                   Color="Color.Primary"
                                                   Size="Size.Small"
                                                   Style="width: 80px;" />
                                <MudText Typo="Typo.caption">@grp.Count()</MudText>
                            </MudStack>
                        </MudStack>
                    }
                    @if (!_records.Any())
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No data yet.</MudText>
                    }
                </MudCardContent>
            </MudCard>

            <!-- Recent Transactions placeholder -->
            <MudCard Elevation="2">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Recent Transactions</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @foreach (var t in _staticTransactions)
                    {
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudAvatar Color="@t.Color">@t.Initial</MudAvatar>
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2">@t.Name</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@t.Date</MudText>
                                </MudStack>
                            </MudStack>
                            <MudText Typo="Typo.body1" Color="Color.Primary">@t.Amount</MudText>
                        </MudStack>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private List<PersonRecord> _records = new();
    private string _searchString = "";

    private int _completedCount;
    private int _activeCount;
    private int _hostCompanyCount;

    private string[] _daysOfWeek = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
    private List<ChartSeries> _projectAnalysisData = new();
    private ChartOptions _chartOptions = new ChartOptions { YAxisTicks = 20, MaxNumYAxisTicks = 5 };

    private record TransactionItem(string Name, string Date, string Amount, string Initial, Color Color);
    private List<TransactionItem> _staticTransactions = new()
    {
        new("Simon Cowell", "Sep 29, 2023", "$21,442", "S", Color.Primary),
        new("Melissa Blue", "Mar 29, 2023", "$8,789", "M", Color.Info),
        new("Gabriel Shin", "Mar 16, 2023", "$13,677", "G", Color.Success),
    };

    protected override void OnInitialized()
    {
        ExcelDataService.OnDataChanged += OnDataRefresh;
        LoadData();
    }

    private void OnDataRefresh()
    {
        LoadData();
        InvokeAsync(StateHasChanged);
    }

    private void LoadData()
    {
        _records = ExcelDataService.GetRecords();
        _completedCount = _records.Count(r => r.PeriodOfPlacement >= 100);
        _activeCount = _records.Count(r => r.IsActivePlacement);
        _hostCompanyCount = _records.Select(r => r.HostCompany).Distinct().Count(c => !string.IsNullOrWhiteSpace(c));

        _projectAnalysisData = new List<ChartSeries>
        {
            new ChartSeries { Name = "Placements", Data = new double[] { 30, 50, 40, 35, 55, 60, 75 } },
            new ChartSeries { Name = "Active", Data = new double[] { 25, 40, 35, 30, 45, 50, 65 } }
        };
    }

    public void Dispose() => ExcelDataService.OnDataChanged -= OnDataRefresh;

    private List<PersonRecord> GetFilteredProjects()
    {
        var source = _records.Take(50);
        if (string.IsNullOrWhiteSpace(_searchString)) return source.ToList();
        return source.Where(r =>
            r.HostCompany.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
            r.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
            r.Surname.Contains(_searchString, StringComparison.OrdinalIgnoreCase)
        ).ToList();
    }

    private Color GetProgressColor(int progress) =>
        progress >= 75 ? Color.Success : progress >= 50 ? Color.Primary : progress >= 25 ? Color.Warning : Color.Error;

    private Color GetStatusColor(PersonRecord r) =>
        r.PeriodOfPlacement >= 100 ? Color.Success : r.IsActivePlacement ? Color.Primary : Color.Warning;

    private string GetStatusText(PersonRecord r) =>
        r.PeriodOfPlacement >= 100 ? "Completed" : r.IsActivePlacement ? "In Progress" : "Pending";
}
