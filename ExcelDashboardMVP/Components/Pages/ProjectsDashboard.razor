@page "/dashboard/projects"
@using ExcelDashboardMVP.Models
@using ExcelDashboardMVP.Services
@inject ExcelDataService ExcelDataService

<PageTitle>Projects Dashboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <!-- Page Header -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" Class="d-flex justify-space-between align-center">
            <MudText Typo="Typo.h4" Color="Color.Primary">Projects</MudText>
            <MudButtonGroup Variant="Variant.Outlined" Color="Color.Primary">
                <MudButton StartIcon="@Icons.Material.Filled.Dashboard">Dashboards</MudButton>
                <MudButton StartIcon="@Icons.Material.Filled.Folder" Variant="Variant.Filled">Projects</MudButton>
            </MudButtonGroup>
        </MudItem>
    </MudGrid>

    <!-- Top Metrics Cards -->
    <MudGrid Spacing="3" Class="mb-4">
        <!-- Completed Projects -->
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row AlignItems="AlignItems.Start" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Completed Projects</MudText>
                            <MudText Typo="Typo.h4">@completedCount</MudText>
                            @* FIX: Added T="string" to MudChip *@
                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.TrendingUp">
                                +8% this month
                            </MudChip>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Primary" Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Overdue Projects -->
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row AlignItems="AlignItems.Start" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Overdue Projects</MudText>
                            <MudText Typo="Typo.h4">@overdueCount</MudText>
                            @* FIX: Added T="string" to MudChip *@
                            <MudChip T="string" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.TrendingDown">
                                +3.25% this month
                            </MudChip>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Info" Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Total Projects -->
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row AlignItems="AlignItems.Start" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Total Projects</MudText>
                            <MudText Typo="Typo.h4">@totalProjects</MudText>
                            @* FIX: Added T="string" to MudChip *@
                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.TrendingUp">
                                +0.81% this month
                            </MudChip>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.Folder" Color="Color.Success" Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Pending Projects -->
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row AlignItems="AlignItems.Start" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Pending Projects</MudText>
                            <MudText Typo="Typo.h4">@pendingCount</MudText>
                            @* FIX: Added T="string" to MudChip *@
                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.TrendingUp">
                                +4.66% this month
                            </MudChip>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" Color="Color.Warning" Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Main Content Grid -->
    <MudGrid Spacing="3">
        <!-- Left Column: Team Members, Tasks, Charts -->
        <MudItem xs="12" md="8">
            <!-- Project Analysis Chart -->
            <MudCard Elevation="2" Class="mb-3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Project Analysis</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudButton Size="Size.Small" Variant="Variant.Text">View All</MudButton>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudChart ChartType="ChartType.Bar" 
                              ChartSeries="@projectAnalysisData" 
                              XAxisLabels="@daysOfWeek"
                              Width="100%" 
                              Height="250px"
                              ChartOptions="@chartOptions"/>
                </MudCardContent>
            </MudCard>

            <!-- Projects Summary Table -->
            <MudCard Elevation="2">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Projects Summary</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudTextField @bind-Value="searchString" 
                                    Placeholder="Search Here" 
                                    Adornment="Adornment.Start" 
                                    AdornmentIcon="@Icons.Material.Filled.Search" 
                                    IconSize="Size.Small"
                                    Variant="Variant.Outlined"
                                    Margin="Margin.Dense"
                                    Class="mr-2"/>
                        <MudButton StartIcon="@Icons.Material.Filled.Add" 
                                   Variant="Variant.Filled" 
                                   Color="Color.Primary"
                                   Size="Size.Small">
                            Sort By
                        </MudButton>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent Class="pa-0">
                    <MudTable Items="@GetFilteredProjects()" 
                              Hover="true" 
                              Dense="true"
                              FixedHeader="true"
                              Height="400px">
                        <HeaderContent>
                            <MudTh>S.No</MudTh>
                            <MudTh>Title</MudTh>
                            <MudTh>Assigned To</MudTh>
                            <MudTh>Tasks</MudTh>
                            <MudTh>Progress</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh>Due Date</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="S.No">@context.Number</MudTd>
                            <MudTd DataLabel="Title">@context.HostCompany</MudTd>
                            <MudTd DataLabel="Assigned To">
                                <MudAvatarGroup Max="3" Spacing="2">
                                    <MudAvatar Color="Color.Primary" Size="Size.Small">@context.Name.Substring(0, 1)</MudAvatar>
                                    <MudAvatar Color="Color.Secondary" Size="Size.Small">@context.Surname.Substring(0, 1)</MudAvatar>
                                </MudAvatarGroup>
                            </MudTd>
                            <MudTd DataLabel="Tasks">@($"{context.PeriodOfPlacement}/100")</MudTd>
                            <MudTd DataLabel="Progress">
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                    <MudProgressLinear Color="@GetProgressColor(context.PeriodOfPlacement)" 
                                                     Value="@context.PeriodOfPlacement" 
                                                     Size="Size.Small" 
                                                     Style="width: 80px;"/>
                                    <MudText Typo="Typo.caption">@context.PeriodOfPlacement%</MudText>
                                </MudStack>
                            </MudTd>
                            <MudTd DataLabel="Status">
                                @* FIX: Added T="string" to MudChip *@
                                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context)">
                                    @GetStatusText(context)
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Due Date">@context.EndDate?.ToString("dd-MM-yyyy")</MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Right Column: Team Members, Daily Tasks, Transactions -->
        <MudItem xs="12" md="4">
            <!-- Team Members -->
            <MudCard Elevation="2" Class="mb-3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Team Members</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudButton Size="Size.Small" Variant="Variant.Text">View All</MudButton>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    @foreach (var member in GetTeamMembers().Take(5))
                    {
                        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudAvatar Color="Color.Primary">@member.Name.Substring(0, 1)</MudAvatar>
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2">@member.FullName</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@member.JobType</MudText>
                                </MudStack>
                            </MudStack>
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Success" Size="Size.Small" />
                        </MudStack>
                    }
                </MudCardContent>
            </MudCard>

            <!-- Daily Tasks -->
            <MudCard Elevation="2" Class="mb-3">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Daily Tasks</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudButton Size="Size.Small" Variant="Variant.Text">View All</MudButton>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    @foreach (var task in GetDailyTasks())
                    {
                        <MudCard Outlined Class="mb-2 pa-2">
                            <MudStack Spacing="1">
                                <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                    <MudText Typo="Typo.body2">@task.Title</MudText>
                                    <MudIconButton Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" />
                                </MudStack>
                                <MudStack Row Spacing="1">
                                    @* FIX: Added T="string" to MudChip *@
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text">@task.Category</MudChip>
                                    <MudChip T="string" Size="Size.Small" Color="@task.StatusColor">@task.Status</MudChip>
                                </MudStack>
                                <MudAvatarGroup Max="3" Spacing="1">
                                    @foreach (var avatar in task.Avatars)
                                    {
                                        <MudAvatar Color="Color.Primary" Size="Size.Small">@avatar</MudAvatar>
                                    }
                                </MudAvatarGroup>
                            </MudStack>
                        </MudCard>
                    }
                </MudCardContent>
            </MudCard>

            <!-- Recent Transactions -->
            <MudCard Elevation="2">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Recent Transactions</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudButton Size="Size.Small" Variant="Variant.Text">View All</MudButton>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    @foreach (var transaction in GetRecentTransactions())
                    {
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudAvatar Color="@transaction.Color">@transaction.Initial</MudAvatar>
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2">@transaction.Name</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@transaction.Date</MudText>
                                </MudStack>
                            </MudStack>
                            <MudText Typo="Typo.body1" Color="Color.Primary">@transaction.Amount</MudText>
                        </MudStack>
                    }
                </MudCardContent>
            </MudCard>

            <!-- Progress Tracker Illustration -->
            <MudCard Elevation="2" Class="mt-3" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <MudCardContent Class="text-center pa-6">
                    <MudIcon Icon="@Icons.Material.Filled.Insights" Color="Color.Default" Size="Size.Large" Style="color: white; font-size: 4rem;" />
                    <MudText Typo="Typo.h6" Style="color: white;" Class="mt-2">Track your work progress here</MudText>
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               Class="mt-3"
                               Style="background-color: white; color: #667eea;">
                        Track Here
                    </MudButton>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private List<PersonRecord> records = new();
    private string searchString = "";

    private int completedCount = 109;
    private int overdueCount = 18;
    private int totalProjects = 389;
    private int pendingCount = 227;

    private string[] daysOfWeek = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };

    private List<ChartSeries> projectAnalysisData = new();
    private ChartOptions chartOptions = new ChartOptions();

    protected override void OnInitialized()
    {
        records = ExcelDataService.GetRecords();
        
        projectAnalysisData = new List<ChartSeries>
        {
            new ChartSeries { Name = "Projects", Data = new double[] { 30, 50, 40, 35, 55, 60, 75 } },
            new ChartSeries { Name = "Tasks", Data = new double[] { 25, 40, 35, 30, 45, 50, 65 } },
            new ChartSeries { Name = "Revenue", Data = new double[] { 20, 35, 30, 25, 40, 45, 60 } }
        };

        chartOptions.YAxisTicks = 20;
        chartOptions.MaxNumYAxisTicks = 5;
    }

    private List<PersonRecord> GetFilteredProjects()
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return records.Take(6).ToList();

        return records.Where(r => 
            r.HostCompany.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
            r.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
            r.Surname.Contains(searchString, StringComparison.OrdinalIgnoreCase)
        ).Take(6).ToList();
    }

    private List<PersonRecord> GetTeamMembers()
    {
        return records.Take(10).ToList();
    }

    private Color GetProgressColor(int progress)
    {
        if (progress >= 75) return Color.Success;
        if (progress >= 50) return Color.Primary;
        if (progress >= 25) return Color.Warning;
        return Color.Error;
    }

    private Color GetStatusColor(PersonRecord record)
    {
        if (record.PeriodOfPlacement == 100) return Color.Success;
        if (record.IsActivePlacement) return Color.Primary;
        if (record.PeriodOfPlacement == 0) return Color.Default;
        return Color.Warning;
    }

    private string GetStatusText(PersonRecord record)
    {
        if (record.PeriodOfPlacement == 100) return "Completed";
        if (record.IsActivePlacement) return "In Progress";
        if (record.PeriodOfPlacement > 0) return "Pending";
        return "Pending";
    }

    private class DailyTask
    {
        public string Title { get; set; } = "";
        public string Category { get; set; } = "";
        public string Status { get; set; } = "";
        public Color StatusColor { get; set; }
        public List<string> Avatars { get; set; } = new();
    }

    private List<DailyTask> GetDailyTasks()
    {
        return new List<DailyTask>
        {
            new DailyTask { Title = "Home Page Design", Category = "Frontend", Status = "Dev", StatusColor = Color.Info, Avatars = new() { "M", "J", "K" } },
            new DailyTask { Title = "About Us Page redesign", Category = "Design", Status = "Dev", StatusColor = Color.Success, Avatars = new() { "A", "B" } },
            new DailyTask { Title = "About Us Page redesign", Category = "Design", Status = "Dev", StatusColor = Color.Success, Avatars = new() { "C", "D" } },
            new DailyTask { Title = "New Project Discussion", Category = "Discussion", Status = "Completed", StatusColor = Color.Success, Avatars = new() { "E", "F", "G" } }
        };
    }

    private class Transaction
    {
        public string Name { get; set; } = "";
        public string Date { get; set; } = "";
        public string Amount { get; set; } = "";
        public string Initial { get; set; } = "";
        public Color Color { get; set; }
    }

    private List<Transaction> GetRecentTransactions()
    {
        return new List<Transaction>
        {
            new Transaction { Name = "Simon Cowell", Date = "Sep 29, 2023 / 12:04PM", Amount = "$21,442", Initial = "S", Color = Color.Primary },
            new Transaction { Name = "Melissa Blue", Date = "Mar 29, 2023 / 10:44AM", Amount = "$8,789", Initial = "M", Color = Color.Info },
            new Transaction { Name = "Gabriel Shin", Date = "Mar 16, 2023 / 05:27PM", Amount = "$13,677", Initial = "G", Color = Color.Success },
            new Transaction { Name = "Yohaansi Nakyuno", Date = "Mar 16, 2023 / 04:43PM", Amount = "$3,543", Initial = "Y", Color = Color.Warning },
            new Transaction { Name = "Brenda Lynn", Date = "Mar 16, 2023 / 02:25PM", Amount = "$7,890", Initial = "B", Color = Color.Error }
        };
    }
}
