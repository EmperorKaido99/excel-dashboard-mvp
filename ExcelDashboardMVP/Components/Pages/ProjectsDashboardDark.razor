@page "/dashboard/projects-dark"
@using ExcelDashboardMVP.Models
@using ExcelDashboardMVP.Services
@inject ExcelDataService ExcelDataService
@implements IDisposable

<PageTitle>Projects Dashboard - Dark</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4"
              Style="background-color: #0a1929; min-height: 100vh;">
    <!-- Header -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" Class="d-flex justify-space-between align-center">
            <MudText Typo="Typo.h4" Style="color: white;">Projects</MudText>
        </MudItem>
    </MudGrid>

    <!-- Metrics -->
    <MudGrid Spacing="3" Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background-color: #1e293b; color: white;">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudText Typo="Typo.body2" Style="color:rgba(255,255,255,0.7);">
                                Completed Placements
                            </MudText>
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle"
                                     Color="Color.Primary" Size="Size.Large" />
                        </MudStack>
                        <MudText Typo="Typo.h4">@_completedCount</MudText>
                        <MudChip T="string" Size="Size.Small" Color="Color.Success"
                                 Icon="@Icons.Material.Filled.TrendingUp">
                            +8% this month
                        </MudChip>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background-color: #1e293b; color: white;">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudText Typo="Typo.body2" Style="color:rgba(255,255,255,0.7);">
                                Active Placements
                            </MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Work"
                                     Color="Color.Info" Size="Size.Large" />
                        </MudStack>
                        <MudText Typo="Typo.h4">@_activeCount</MudText>
                        <MudChip T="string" Size="Size.Small" Color="Color.Info"
                                 Icon="@Icons.Material.Filled.Circle">
                            Currently placed
                        </MudChip>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background-color: #1e293b; color: white;">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudText Typo="Typo.body2" Style="color:rgba(255,255,255,0.7);">
                                Total Participants
                            </MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Folder"
                                     Color="Color.Success" Size="Size.Large" />
                        </MudStack>
                        <MudText Typo="Typo.h4">@records.Count</MudText>
                        <MudChip T="string" Size="Size.Small" Color="Color.Success"
                                 Icon="@Icons.Material.Filled.TrendingUp">
                            +0.81% this month
                        </MudChip>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background-color: #1e293b; color: white;">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudText Typo="Typo.body2" Style="color:rgba(255,255,255,0.7);">
                                Pending Placements
                            </MudText>
                            <MudIcon Icon="@Icons.Material.Filled.HourglassEmpty"
                                     Color="Color.Warning" Size="Size.Large" />
                        </MudStack>
                        <MudText Typo="Typo.h4">@_pendingCount</MudText>
                        <MudChip T="string" Size="Size.Small" Color="Color.Success"
                                 Icon="@Icons.Material.Filled.TrendingUp">
                            +4.66% this month
                        </MudChip>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Main Grid -->
    <MudGrid Spacing="3">
        <!-- Left: Chart + Table -->
        <MudItem xs="12" md="8">
            <MudCard Style="background-color: #1e293b; color: white;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Project Analysis</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudChart ChartType="ChartType.Bar"
                              ChartSeries="@projectAnalysisData"
                              XAxisLabels="@daysOfWeek"
                              Width="100%" Height="250px"
                              ChartOptions="@chartOptions" />
                </MudCardContent>
            </MudCard>

            <MudCard Class="mt-3" Style="background-color: #1e293b; color: white;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Projects Summary</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudTextField @bind-Value="searchString"
                                      Placeholder="Search Here"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      IconSize="Size.Small"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Style="color: white;"
                                      Class="mr-2"
                                      Immediate="true"
                                      DebounceInterval="200" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent Class="pa-0">
                    <MudTable Items="@GetFilteredProjects()"
                              Hover="true" Dense="true"
                              FixedHeader="true" Height="400px"
                              Style="background-color: transparent;">
                        <HeaderContent>
                            <MudTh Style="color:rgba(255,255,255,0.7);">S.No</MudTh>
                            <MudTh Style="color:rgba(255,255,255,0.7);">Title</MudTh>
                            <MudTh Style="color:rgba(255,255,255,0.7);">Assigned To</MudTh>
                            <MudTh Style="color:rgba(255,255,255,0.7);">Tasks</MudTh>
                            <MudTh Style="color:rgba(255,255,255,0.7);">Progress</MudTh>
                            <MudTh Style="color:rgba(255,255,255,0.7);">Status</MudTh>
                            <MudTh Style="color:rgba(255,255,255,0.7);">Due Date</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="S.No" Style="color:white;">@context.Number</MudTd>
                            <MudTd DataLabel="Title" Style="color:white;">@context.HostCompany</MudTd>
                            <MudTd DataLabel="Assigned To">
                                <MudAvatarGroup Max="3" Spacing="2">
                                    <MudAvatar Color="Color.Primary" Size="Size.Small">
                                        @context.Name.Substring(0, 1)
                                    </MudAvatar>
                                    <MudAvatar Color="Color.Secondary" Size="Size.Small">
                                        @context.Surname.Substring(0, 1)
                                    </MudAvatar>
                                </MudAvatarGroup>
                            </MudTd>
                            <MudTd DataLabel="Tasks" Style="color:white;">
                                @($"{context.PeriodOfPlacement}/100")
                            </MudTd>
                            <MudTd DataLabel="Progress">
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                    <MudProgressLinear
                                        Color="@GetProgressColor(context.PeriodOfPlacement)"
                                        Value="@context.PeriodOfPlacement"
                                        Size="Size.Small" Style="width: 80px;" />
                                    <MudText Typo="Typo.caption" Style="color:white;">
                                        @context.PeriodOfPlacement%
                                    </MudText>
                                </MudStack>
                            </MudTd>
                            <MudTd DataLabel="Status">
                                <MudChip T="string" Size="Size.Small"
                                         Color="@GetStatusColor(context)">
                                    @GetStatusText(context)
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Due Date" Style="color:rgba(255,255,255,0.7);">
                                @context.EndDate?.ToString("dd-MM-yyyy")
                            </MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText Align="Align.Center"
                                     Style="color:rgba(255,255,255,0.5);" Class="pa-4">
                                Upload data to populate.
                            </MudText>
                        </NoRecordsContent>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Right: Team + Tasks + Sponsors -->
        <MudItem xs="12" md="4">
            <!-- Team Members (hardcoded) -->
            <MudCard Style="background-color: #1e293b; color: white;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Team Members</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @foreach (var m in _teamMembers)
                    {
                        <MudStack Row AlignItems="AlignItems.Center"
                                  Justify="Justify.SpaceBetween" Class="mb-3">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudAvatar Color="@m.AvatarColor">@m.Initial</MudAvatar>
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2" Style="color:white;">
                                        @m.Name
                                    </MudText>
                                    <MudText Typo="Typo.caption"
                                             Style="color:rgba(255,255,255,0.5);">
                                        @m.Role
                                    </MudText>
                                </MudStack>
                            </MudStack>
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp"
                                     Color="Color.Success" Size="Size.Small" />
                        </MudStack>
                    }
                </MudCardContent>
            </MudCard>

            <!-- Projects (hardcoded) -->
            <MudCard Class="mt-3" Style="background-color: #1e293b; color: white;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Projects</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="2">
                        <MudCard Outlined
                                 Style="background-color:#0f172a; border-color:rgba(255,255,255,0.1);">
                            <MudCardContent>
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.Rocket"
                                             Color="Color.Primary" />
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body1" Style="color:white;">
                                            Project Phoenix
                                        </MudText>
                                        <MudText Typo="Typo.caption"
                                                 Style="color:rgba(255,255,255,0.5);">
                                            Cohort 1 – 4
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                        <MudCard Outlined
                                 Style="background-color:#0f172a; border-color:rgba(255,255,255,0.1);">
                            <MudCardContent>
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.LocalFlorist"
                                             Color="Color.Secondary" />
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body1" Style="color:white;">
                                            Project Lotus
                                        </MudText>
                                        <MudText Typo="Typo.caption"
                                                 Style="color:rgba(255,255,255,0.5);">
                                            Cohort 5
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    </MudStack>
                </MudCardContent>
            </MudCard>

            <!-- Sponsors (hardcoded) -->
            <MudCard Class="mt-3"
                     Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <MudCardContent Class="pa-4">
                    <MudText Typo="Typo.h6" Style="color:white;" Class="mb-3">Sponsors</MudText>
                    <MudStack Row Spacing="1" Style="flex-wrap:wrap; gap:8px;">
                        @foreach (var s in _sponsors)
                        {
                            <MudChip T="string" Size="Size.Small"
                                     Style="background:rgba(255,255,255,0.2); color:white;">
                                @s
                            </MudChip>
                        }
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private List<PersonRecord> records = new();
    private string searchString = "";
    private string[] daysOfWeek = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
    private int _completedCount;
    private int _activeCount;
    private int _pendingCount;

    private List<ChartSeries> projectAnalysisData = new();
    private ChartOptions chartOptions = new ChartOptions();

    // ── Hardcoded data ────────────────────────────────────────────────────────

    private record TeamMember(string Name, string Role, string Initial, Color AvatarColor);

    private readonly List<TeamMember> _teamMembers = new()
    {
        new("Amber Dunjwa",      "Admin · PA · AI Content Dev", "A", Color.Primary),
        new("Sibusiso Skhosana", "Facilitation · Recruitment",  "S", Color.Secondary),
        new("Chulumanco Mbete",  "Platform Admin",              "C", Color.Info),
        new("Jessey Foster",     "AI Content Development",      "J", Color.Success),
        new("Jordan Philips",    "AI Content Development",      "J", Color.Warning),
        new("Rayhaan Arendse",   "Cloud Admin · AI Content Dev","R", Color.Error),
        new("Naeemah Adams",     "Main Admin",                  "N", Color.Primary),
        new("Mary",              "Senior Manager",              "M", Color.Info),
        new("Judy",              "Director",                    "J", Color.Secondary),
        new("Magda",             "Consultant",                  "M", Color.Success),
    };

    private readonly List<string> _sponsors = new()
    {
        "Collective X", "YES", "DEDAT", "Excellerate CPT"
    };

    // ── Lifecycle ─────────────────────────────────────────────────────────────

    protected override void OnInitialized()
    {
        ExcelDataService.OnDataChanged += OnDataRefresh;
        LoadData();
    }

    private void OnDataRefresh()
    {
        LoadData();
        InvokeAsync(StateHasChanged);
    }

    private void LoadData()
    {
        records = ExcelDataService.GetRecords();
        _completedCount = records.Count(r => r.PeriodOfPlacement >= 100);
        _activeCount    = records.Count(r => r.IsActivePlacement);
        _pendingCount   = records.Count(r => !r.IsActivePlacement && r.PeriodOfPlacement < 100);

        projectAnalysisData = new List<ChartSeries>
        {
            new ChartSeries { Name = "Placements", Data = new double[] { 30, 50, 40, 35, 55, 60, 75 } },
            new ChartSeries { Name = "Active",     Data = new double[] { 25, 40, 35, 30, 45, 50, 65 } },
            new ChartSeries { Name = "Pending",    Data = new double[] { 20, 35, 30, 25, 40, 45, 60 } }
        };
        chartOptions.YAxisTicks = 20;
        chartOptions.MaxNumYAxisTicks = 5;
    }

    public void Dispose() => ExcelDataService.OnDataChanged -= OnDataRefresh;

    // ── Helpers ───────────────────────────────────────────────────────────────

    private List<PersonRecord> GetFilteredProjects()
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return records.Take(50).ToList();
        return records.Where(r =>
            r.HostCompany.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
            r.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase)
        ).Take(50).ToList();
    }

    private Color GetProgressColor(int p) =>
        p >= 75 ? Color.Success : p >= 50 ? Color.Primary : p >= 25 ? Color.Warning : Color.Error;

    private Color GetStatusColor(PersonRecord r) =>
        r.PeriodOfPlacement >= 100 ? Color.Success
        : r.IsActivePlacement ? Color.Primary
        : Color.Warning;

    private string GetStatusText(PersonRecord r) =>
        r.PeriodOfPlacement >= 100 ? "Completed"
        : r.IsActivePlacement ? "In Progress"
        : "Pending";
}
