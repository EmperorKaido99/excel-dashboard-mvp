@page "/dashboard/projects-dark"
@rendermode InteractiveServer
@using ExcelDashboardMVP.Models
@using ExcelDashboardMVP.Services
@inject ExcelDataService ExcelDataService
@implements IDisposable

<PageTitle>Projects Dashboard - Dark</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4"
              Style="background-color:#0a1929; min-height:100vh;">

    @* ── Header ──────────────────────────────────────────────────────────── *@
    <MudGrid Class="mb-4">
        <MudItem xs="12" Class="d-flex justify-space-between align-center">
            <MudText Typo="Typo.h4" Style="color:white;">Projects</MudText>
        </MudItem>
    </MudGrid>

    @* ── Metrics ─────────────────────────────────────────────────────────── *@
    <MudGrid Spacing="3" Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background-color:#1e293b; color:white;">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudText Typo="Typo.body2" Style="color:rgba(255,255,255,0.7);">
                                Total Participants
                            </MudText>
                            <MudIcon Icon="@Icons.Material.Filled.People"
                                     Color="Color.Primary" Size="Size.Large" />
                        </MudStack>
                        <MudText Typo="Typo.h4">@_records.Count</MudText>
                        <MudChip T="string" Size="Size.Small" Color="Color.Success"
                                 Icon="@Icons.Material.Filled.TrendingUp">
                            In system
                        </MudChip>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background-color:#1e293b; color:white;">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudText Typo="Typo.body2" Style="color:rgba(255,255,255,0.7);">
                                Host Companies
                            </MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Business"
                                     Color="Color.Info" Size="Size.Large" />
                        </MudStack>
                        <MudText Typo="Typo.h4">@_hostCount</MudText>
                        <MudChip T="string" Size="Size.Small" Color="Color.Info"
                                 Icon="@Icons.Material.Filled.Business">
                            Unique hosts
                        </MudChip>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background-color:#1e293b; color:white;">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudText Typo="Typo.body2" Style="color:rgba(255,255,255,0.7);">
                                Municipalities
                            </MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Map"
                                     Color="Color.Success" Size="Size.Large" />
                        </MudStack>
                        <MudText Typo="Typo.h4">@_municipalityCount</MudText>
                        <MudChip T="string" Size="Size.Small" Color="Color.Success"
                                 Icon="@Icons.Material.Filled.LocationCity">
                            Coverage areas
                        </MudChip>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background-color:#1e293b; color:white;">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudText Typo="Typo.body2" Style="color:rgba(255,255,255,0.7);">
                                Lead Companies
                            </MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Folder"
                                     Color="Color.Warning" Size="Size.Large" />
                        </MudStack>
                        <MudText Typo="Typo.h4">@_leadCount</MudText>
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning"
                                 Icon="@Icons.Material.Filled.TrendingUp">
                            Unique leads
                        </MudChip>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    @* ── Main Grid ────────────────────────────────────────────────────────── *@
    <MudGrid Spacing="3">

        @* ── Left: Chart + Table ─────────────────────────────────────────── *@
        <MudItem xs="12" md="8">

            <MudCard Style="background-color:#1e293b; color:white;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Job Type Analysis</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudChart ChartType="ChartType.Bar"
                              ChartSeries="@_chartData"
                              XAxisLabels="@_chartLabels"
                              Width="100%" Height="250px"
                              ChartOptions="@_chartOptions" />
                </MudCardContent>
            </MudCard>

            <MudCard Class="mt-3" Style="background-color:#1e293b; color:white;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Projects Summary</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudTextField @bind-Value="_searchString"
                                      Placeholder="Search Here"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      IconSize="Size.Small"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Class="mr-2"
                                      Immediate="true"
                                      DebounceInterval="200" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent Class="pa-0">
                    <MudTable Items="@GetFiltered()"
                              Hover="true" Dense="true"
                              FixedHeader="true" Height="400px"
                              Style="background-color:transparent;">
                        <HeaderContent>
                            <MudTh Style="color:rgba(255,255,255,0.7);">#</MudTh>
                            <MudTh Style="color:rgba(255,255,255,0.7);">Name</MudTh>
                            <MudTh Style="color:rgba(255,255,255,0.7);">Host Company</MudTh>
                            <MudTh Style="color:rgba(255,255,255,0.7);">Job Type</MudTh>
                            <MudTh Style="color:rgba(255,255,255,0.7);">Municipality</MudTh>
                            <MudTh Style="color:rgba(255,255,255,0.7);">Emp. Status</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="#" Style="color:white;">@context.RowNumber</MudTd>
                            <MudTd DataLabel="Name">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudAvatar Color="Color.Primary" Size="Size.Small">
                                        @(context.Name.Length > 0 ? context.Name[0].ToString() : "?")
                                    </MudAvatar>
                                    <MudText Typo="Typo.body2" Style="color:white;">
                                        @context.FullName
                                    </MudText>
                                </MudStack>
                            </MudTd>
                            <MudTd Style="color:white;">@context.HostCompany</MudTd>
                            <MudTd Style="color:white;">@context.JobType</MudTd>
                            <MudTd Style="color:white;">@context.LocalMunicipality</MudTd>
                            <MudTd>
                                <MudChip T="string" Size="Size.Small"
                                         Color="@GetStatusColor(context.EmploymentStatus)">
                                    @(string.IsNullOrWhiteSpace(context.EmploymentStatus)
                                        ? "Unknown" : context.EmploymentStatus)
                                </MudChip>
                            </MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText Align="Align.Center"
                                     Style="color:rgba(255,255,255,0.5);" Class="pa-4">
                                Upload data to populate.
                            </MudText>
                        </NoRecordsContent>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>

        @* ── Right: Team + Projects + Sponsors ──────────────────────────── *@
        <MudItem xs="12" md="4">

            @* Team Members *@
            <MudCard Style="background-color:#1e293b; color:white;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Team Members</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @foreach (var m in _teamMembers)
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center"
                                  Justify="Justify.SpaceBetween" Class="mb-3">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudAvatar Color="@m.AvatarColor">@m.Initial</MudAvatar>
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2" Style="color:white;">@m.Name</MudText>
                                    <MudText Typo="Typo.caption"
                                             Style="color:rgba(255,255,255,0.5);">
                                        @m.Role
                                    </MudText>
                                </MudStack>
                            </MudStack>
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp"
                                     Color="Color.Success" Size="Size.Small" />
                        </MudStack>
                    }
                </MudCardContent>
            </MudCard>

            @* Projects *@
            <MudCard Class="mt-3" Style="background-color:#1e293b; color:white;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Projects</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="2">
                        <MudCard Outlined="true"
                                 Style="background-color:#0f172a; border-color:rgba(255,255,255,0.1);">
                            <MudCardContent>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.Rocket" Color="Color.Primary" />
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body1" Style="color:white;">
                                            Project Phoenix
                                        </MudText>
                                        <MudText Typo="Typo.caption"
                                                 Style="color:rgba(255,255,255,0.5);">
                                            Cohort 1 – 4
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                        <MudCard Outlined="true"
                                 Style="background-color:#0f172a; border-color:rgba(255,255,255,0.1);">
                            <MudCardContent>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.LocalFlorist"
                                             Color="Color.Secondary" />
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body1" Style="color:white;">
                                            Project Lotus
                                        </MudText>
                                        <MudText Typo="Typo.caption"
                                                 Style="color:rgba(255,255,255,0.5);">
                                            Cohort 5
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    </MudStack>
                </MudCardContent>
            </MudCard>

            @* Sponsors *@
            <MudCard Class="mt-3"
                     Style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);">
                <MudCardContent Class="pa-4">
                    <MudText Typo="Typo.h6" Style="color:white;" Class="mb-3">Sponsors</MudText>
                    <MudStack Row="true" Spacing="1" Style="flex-wrap:wrap; gap:8px;">
                        @foreach (var s in _sponsors)
                        {
                            <MudChip T="string" Size="Size.Small"
                                     Style="background:rgba(255,255,255,0.2); color:white;">
                                @s
                            </MudChip>
                        }
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private List<PersonRecord> _records = new();
    private string _searchString = "";

    private int _hostCount;
    private int _municipalityCount;
    private int _leadCount;

    private List<ChartSeries> _chartData   = new();
    private string[]          _chartLabels = Array.Empty<string>();
    private ChartOptions      _chartOptions = new() { YAxisTicks = 5, MaxNumYAxisTicks = 5 };

    // ── Hardcoded data ──────────────────────────────────────────────────────
    private record TeamMember(string Name, string Role, string Initial, Color AvatarColor);

    private readonly List<TeamMember> _teamMembers = new()
    {
        new("Amber Dunjwa",      "Admin · PA · AI Content Dev", "A", Color.Primary),
        new("Sibusiso Skhosana", "Facilitation · Recruitment",  "S", Color.Secondary),
        new("Chulumanco Mbete",  "Platform Admin",              "C", Color.Info),
        new("Jessey Foster",     "AI Content Development",      "J", Color.Success),
        new("Jordan Philips",    "AI Content Development",      "J", Color.Warning),
        new("Rayhaan Arendse",   "Cloud Admin · AI Content Dev","R", Color.Error),
        new("Naeemah Adams",     "Main Admin",                  "N", Color.Primary),
        new("Mary",              "Senior Manager",              "M", Color.Info),
        new("Judy",              "Director",                    "J", Color.Secondary),
        new("Magda",             "Consultant",                  "M", Color.Success),
    };

    private readonly List<string> _sponsors = new()
    {
        "Collective X", "YES", "DEDAT", "Excellerate CPT"
    };

    // ── Lifecycle ──────────────────────────────────────────────────────────
    protected override void OnInitialized()
    {
        ExcelDataService.OnDataChanged += Reload;
        LoadData();
    }
    private void Reload() { LoadData(); InvokeAsync(StateHasChanged); }
    public void Dispose() => ExcelDataService.OnDataChanged -= Reload;

    private void LoadData()
    {
        _records           = ExcelDataService.GetRecords();
        _hostCount         = _records.Select(r => r.HostCompany).Where(s => !string.IsNullOrWhiteSpace(s)).Distinct().Count();
        _municipalityCount = _records.Select(r => r.LocalMunicipality).Where(s => !string.IsNullOrWhiteSpace(s)).Distinct().Count();
        _leadCount         = _records.Select(r => r.LeadCompany).Where(s => !string.IsNullOrWhiteSpace(s)).Distinct().Count();

        var groups = _records
            .GroupBy(r => r.JobType)
            .Where(g => !string.IsNullOrWhiteSpace(g.Key))
            .OrderByDescending(g => g.Count()).Take(7).ToList();

        _chartLabels = groups.Select(g => g.Key.Length > 12 ? g.Key[..12] + "…" : g.Key).ToArray();
        _chartData = new List<ChartSeries>
        {
            new() { Name = "Participants", Data = groups.Select(g => (double)g.Count()).ToArray() },
        };
    }

    private List<PersonRecord> GetFiltered()
    {
        var q = _records.AsEnumerable();
        if (!string.IsNullOrWhiteSpace(_searchString))
            q = q.Where(r =>
                r.FullName.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
                r.HostCompany.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
                r.JobType.Contains(_searchString, StringComparison.OrdinalIgnoreCase));
        return q.Take(50).ToList();
    }

    private Color GetStatusColor(string status) => status?.ToLowerInvariant() switch
    {
        var s when s?.Contains("employed") == true   => Color.Success,
        var s when s?.Contains("unemployed") == true => Color.Error,
        var s when s?.Contains("student") == true    => Color.Info,
        _ => Color.Default
    };
}
