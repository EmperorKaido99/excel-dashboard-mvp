@page "/dashboard/courses"
@using ExcelDashboardMVP.Models
@using ExcelDashboardMVP.Services
@inject ExcelDataService ExcelDataService
@implements IDisposable

<PageTitle>Courses Dashboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4" Style="background-color: #0a1929; min-height: 100vh;">
    <!-- Page Header â€” NO BUTTONS -->
    <MudGrid Class="mb-4">
        <MudItem xs="12">
            <MudText Typo="Typo.h4" Style="color: white;">Courses</MudText>
            <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.5);">
                @_records.Count participants | @_jobTypeCount unique job types
            </MudText>
        </MudItem>
    </MudGrid>

    <!-- Top Metrics Cards (live from data) -->
    <MudGrid Spacing="3" Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <MudCardContent>
                    <MudStack Spacing="2">
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudText Typo="Typo.body2">Total Participants</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Medium" />
                        </MudStack>
                        <MudText Typo="Typo.h4">@_records.Count</MudText>
                        <MudText Typo="Typo.caption">
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Small" /> In system
                        </MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                <MudCardContent>
                    <MudStack Spacing="2">
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudText Typo="Typo.body2">Active Placements</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.WorkHistory" Size="Size.Medium" />
                        </MudStack>
                        <MudText Typo="Typo.h4">@_activePlacements</MudText>
                        <MudText Typo="Typo.caption">Currently placed</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                <MudCardContent>
                    <MudStack Spacing="2">
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudText Typo="Typo.body2">Job Types</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Code" Size="Size.Medium" />
                        </MudStack>
                        <MudText Typo="Typo.h4">@_jobTypeCount</MudText>
                        <MudText Typo="Typo.caption">Unique categories</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                <MudCardContent>
                    <MudStack Spacing="2">
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudText Typo="Typo.body2">Lead Companies</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Medium" />
                        </MudStack>
                        <MudText Typo="Typo.h4">@_leadCompanyCount</MudText>
                        <MudText Typo="Typo.caption">Unique lead orgs</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Main Content Grid -->
    <MudGrid Spacing="3">
        <!-- Left Column -->
        <MudItem xs="12" md="7">
            <!-- Earnings Report Chart -->
            <MudCard Style="background-color: #1e293b; color: white; height: 400px;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Placement Trends</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudChart ChartType="ChartType.Bar"
                              ChartSeries="@_earningsData"
                              XAxisLabels="@_months"
                              Width="100%"
                              Height="280px"
                              ChartOptions="@_barChartOptions" />
                </MudCardContent>
            </MudCard>

            <!-- Job Type Breakdown -->
            <MudCard Class="mt-3" Style="background-color: #1e293b; color: white;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">By Job Type</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (!_records.Any())
                    {
                        <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.5);">
                            Upload data to see breakdown.
                        </MudText>
                    }
                    @foreach (var grp in _records.GroupBy(r => r.JobType)
                                                 .Where(g => !string.IsNullOrWhiteSpace(g.Key))
                                                 .OrderByDescending(g => g.Count())
                                                 .Take(8))
                    {
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudText Typo="Typo.body2">@grp.Key</MudText>
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudProgressLinear Value="@(_records.Count > 0 ? (double)grp.Count() / _records.Count * 100 : 0)"
                                                   Color="Color.Primary"
                                                   Size="Size.Small"
                                                   Style="width: 100px;" />
                                <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.7); min-width: 30px;">
                                    @grp.Count()
                                </MudText>
                            </MudStack>
                        </MudStack>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Right Column -->
        <MudItem xs="12" md="5">
            <!-- Distribution Chart -->
            <MudCard Style="background-color: #1e293b; color: white; height: 400px;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Employment Status</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent Class="d-flex flex-column align-center justify-center" Style="height: 320px;">
                    <MudChart ChartType="ChartType.Donut"
                              Width="280px"
                              Height="280px"
                              InputData="@_statusDistribution"
                              InputLabels="@_statusLabels"
                              ChartOptions="@_donutChartOptions">
                        <CustomGraphics>
                            <text x="50%" y="48%" text-anchor="middle" font-size="1.4rem" fill="white" font-weight="bold">@_records.Count</text>
                            <text x="50%" y="56%" text-anchor="middle" font-size="0.8rem" fill="rgba(255,255,255,0.7)">Total</text>
                        </CustomGraphics>
                    </MudChart>
                </MudCardContent>
            </MudCard>

            <!-- Disability Stats -->
            <MudCard Class="mt-3" Style="background-color: #1e293b; color: white;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Disability Overview</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid Spacing="2">
                        <MudItem xs="6">
                            <MudStack Spacing="1" Class="text-center">
                                <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.7);">With Disability</MudText>
                                <MudText Typo="Typo.h4" Style="color: #f093fb;">@_withDisability</MudText>
                            </MudStack>
                        </MudItem>
                        <MudItem xs="6">
                            <MudStack Spacing="1" Class="text-center">
                                <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.7);">Without Disability</MudText>
                                <MudText Typo="Typo.h4" Style="color: #4facfe;">@_withoutDisability</MudText>
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Course List Table (static courses, dynamic participant count) -->
    <MudCard Class="mt-3" Style="background-color: #1e293b; color: white;">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Participants by Employment Status</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent Class="pa-0">
            <MudTable Items="@GetStatusBreakdown()" Hover="true" Dense="true" Style="background-color: transparent;">
                <HeaderContent>
                    <MudTh Style="color: rgba(255,255,255,0.7);">Employment Status</MudTh>
                    <MudTh Style="color: rgba(255,255,255,0.7);">Count</MudTh>
                    <MudTh Style="color: rgba(255,255,255,0.7);">Share</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Status" Style="color: white;">
                        @(string.IsNullOrWhiteSpace(context.Key) ? "Unknown" : context.Key)
                    </MudTd>
                    <MudTd DataLabel="Count" Style="color: white;">@context.Count</MudTd>
                    <MudTd DataLabel="Share">
                        <MudProgressLinear Value="@context.Pct"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           Style="width: 120px;" />
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudText Align="Align.Center" Style="color: rgba(255,255,255,0.5);" Class="pa-4">
                        Upload data to see breakdown.
                    </MudText>
                </NoRecordsContent>
            </MudTable>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private List<PersonRecord> _records = new();

    private int _activePlacements;
    private int _jobTypeCount;
    private int _leadCompanyCount;
    private int _withDisability;
    private int _withoutDisability;

    private string[] _months = { "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec" };
    private List<ChartSeries> _earningsData = new();
    private ChartOptions _barChartOptions = new() { YAxisTicks = 20 };
    private ChartOptions _donutChartOptions = new();
    private double[] _statusDistribution = Array.Empty<double>();
    private string[] _statusLabels = Array.Empty<string>();

    protected override void OnInitialized()
    {
        ExcelDataService.OnDataChanged += OnDataRefresh;
        LoadData();
    }

    private void OnDataRefresh()
    {
        LoadData();
        InvokeAsync(StateHasChanged);
    }

    private void LoadData()
    {
        _records = ExcelDataService.GetRecords();
        _activePlacements = _records.Count(r => r.IsActivePlacement);
        _jobTypeCount = _records.Select(r => r.JobType).Distinct().Count(j => !string.IsNullOrWhiteSpace(j));
        _leadCompanyCount = _records.Select(r => r.LeadCompany).Distinct().Count(c => !string.IsNullOrWhiteSpace(c));
        _withDisability = _records.Count(r => r.PersonWithDisability);
        _withoutDisability = _records.Count(r => !r.PersonWithDisability);

        // Build donut data from employment statuses
        var groups = _records.GroupBy(r => r.EmploymentStatus)
                             .Where(g => !string.IsNullOrWhiteSpace(g.Key))
                             .OrderByDescending(g => g.Count())
                             .Take(5)
                             .ToList();

        _statusDistribution = groups.Select(g => (double)g.Count()).ToArray();
        _statusLabels = groups.Select(g => g.Key).ToArray();

        _earningsData = new List<ChartSeries>
        {
            new ChartSeries { Name = "Placements", Data = new double[] { 20, 50, 40, 70, 60, 90, 80, 100, 95, 110, 105, 115 } }
        };
    }

    public void Dispose() => ExcelDataService.OnDataChanged -= OnDataRefresh;

    private record StatusRow(string Key, int Count, double Pct);

    private List<StatusRow> GetStatusBreakdown()
    {
        if (!_records.Any()) return new();
        return _records
            .GroupBy(r => r.EmploymentStatus)
            .OrderByDescending(g => g.Count())
            .Select(g => new StatusRow(
                g.Key,
                g.Count(),
                _records.Count > 0 ? Math.Round((double)g.Count() / _records.Count * 100, 1) : 0))
            .ToList();
    }
}
