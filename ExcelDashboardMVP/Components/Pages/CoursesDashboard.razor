@page "/dashboard/courses"
@rendermode InteractiveServer
@using ExcelDashboardMVP.Models
@using ExcelDashboardMVP.Services
@inject ExcelDataService ExcelDataService
@implements IDisposable

<PageTitle>Courses Dashboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">

    <MudGrid Class="mb-4">
        <MudItem xs="12">
            <MudText Typo="Typo.h4" Color="Color.Primary">Courses</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                @_records.Count participants · Skill Development Programme
            </MudText>
        </MudItem>
    </MudGrid>

    @* ── Metric Cards — white style matching Projects page ───────────────── *@
    <MudGrid Spacing="3" Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row="true" AlignItems="AlignItems.Start" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Total Participants</MudText>
                            <MudText Typo="Typo.h4">@_records.Count</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary"
                                     Icon="@Icons.Material.Filled.People">
                                In system
                            </MudChip>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.People" Color="Color.Primary" Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row="true" AlignItems="AlignItems.Start" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Unique Municipalities</MudText>
                            <MudText Typo="Typo.h4">@_municipalityCount</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Info"
                                     Icon="@Icons.Material.Filled.LocationCity">
                                Coverage areas
                            </MudChip>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.LocationCity" Color="Color.Info" Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row="true" AlignItems="AlignItems.Start" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Courses Offered</MudText>
                            <MudText Typo="Typo.h4">@_courses.Count</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Success"
                                     Icon="@Icons.Material.Filled.School">
                                Skill tracks
                            </MudChip>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.School" Color="Color.Success" Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row="true" AlignItems="AlignItems.Start" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Lead Companies</MudText>
                            <MudText Typo="Typo.h4">@_leadCompanyCount</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning"
                                     Icon="@Icons.Material.Filled.Business">
                                Unique lead orgs
                            </MudChip>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.Business" Color="Color.Warning" Size="Size.Large" />
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <MudGrid Spacing="3">
        <MudItem xs="12" md="7">

            <MudCard Elevation="2">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Skill Development Programme — Courses</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid Spacing="2">
                        @foreach (var course in _courses)
                        {
                            <MudItem xs="12" sm="6">
                                <MudCard Outlined="true">
                                    <MudCardContent>
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudIcon Icon="@course.Icon" Style="@($"color:{course.Color}")" />
                                            <MudStack Spacing="0">
                                                <MudText Typo="Typo.body2">@course.Name</MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@course.Category</MudText>
                                            </MudStack>
                                        </MudStack>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                        }
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            <MudCard Elevation="2" Class="mt-3">
                <MudCardHeader>
                    <CardHeaderContent><MudText Typo="Typo.h6">By Job Type</MudText></CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (!_records.Any())
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Upload data to see breakdown.</MudText>
                    }
                    @foreach (var grp in _records
                        .GroupBy(r => r.JobType)
                        .Where(g => !string.IsNullOrWhiteSpace(g.Key))
                        .OrderByDescending(g => g.Count()).Take(8))
                    {
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudText Typo="Typo.body2">@grp.Key</MudText>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudProgressLinear
                                    Value="@(_records.Count > 0 ? (double)grp.Count() / _records.Count * 100 : 0)"
                                    Color="Color.Primary" Size="Size.Small" Style="width:100px;" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Style="min-width:30px;">@grp.Count()</MudText>
                            </MudStack>
                        </MudStack>
                    }
                </MudCardContent>
            </MudCard>

            <MudCard Elevation="2" Class="mt-3">
                <MudCardHeader>
                    <CardHeaderContent><MudText Typo="Typo.h6">By Municipality</MudText></CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (!_records.Any())
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Upload data to see breakdown.</MudText>
                    }
                    @foreach (var grp in _records
                        .GroupBy(r => r.LocalMunicipality)
                        .Where(g => !string.IsNullOrWhiteSpace(g.Key))
                        .OrderByDescending(g => g.Count()).Take(8))
                    {
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudText Typo="Typo.body2"
                                     Style="min-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                @grp.Key
                            </MudText>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudProgressLinear
                                    Value="@(_records.Count > 0 ? (double)grp.Count() / _records.Count * 100 : 0)"
                                    Color="Color.Info" Size="Size.Small" Style="width:100px;" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Style="min-width:30px;">@grp.Count()</MudText>
                            </MudStack>
                        </MudStack>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="5">

            <MudCard Elevation="2">
                <MudCardHeader>
                    <CardHeaderContent><MudText Typo="Typo.h6">Top Instructors</MudText></CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @foreach (var inst in _instructors)
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudAvatar Color="@inst.AvatarColor" Size="Size.Medium">@inst.Initial</MudAvatar>
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2">@inst.Name</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@inst.Speciality</MudText>
                                </MudStack>
                            </MudStack>
                            <MudChip T="string" Size="Size.Small" Color="Color.Success">Top</MudChip>
                        </MudStack>
                    }
                </MudCardContent>
            </MudCard>

            <MudCard Elevation="2" Class="mt-3">
                <MudCardHeader>
                    <CardHeaderContent><MudText Typo="Typo.h6">Participants by Course</MudText></CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (!_records.Any())
                    {
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.School" Style="font-size:4rem; opacity:0.2;" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Upload data to see course breakdown</MudText>
                        </MudStack>
                    }
                    else
                    {
                        @foreach (var grp in _records
                            .GroupBy(r => r.JobType)
                            .Where(g => !string.IsNullOrWhiteSpace(g.Key))
                            .OrderByDescending(g => g.Count()).Take(7))
                        {
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                                <MudText Typo="Typo.body2"
                                         Style="min-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                    @grp.Key
                                </MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Primary">@grp.Count()</MudChip>
                            </MudStack>
                        }
                    }
                </MudCardContent>
            </MudCard>

            <MudCard Elevation="2" Class="mt-3">
                <MudCardHeader>
                    <CardHeaderContent><MudText Typo="Typo.h6">Demographic Group Breakdown</MudText></CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (!_records.Any())
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Upload data to see breakdown.</MudText>
                    }
                    else
                    {
                        @foreach (var grp in _records
                            .GroupBy(r => r.DemographicGroup)
                            .Where(g => !string.IsNullOrWhiteSpace(g.Key))
                            .OrderByDescending(g => g.Count()).Take(6))
                        {
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                                <MudText Typo="Typo.body2" Style="min-width:100px;">@grp.Key</MudText>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudProgressLinear
                                        Value="@(_records.Count > 0 ? (double)grp.Count() / _records.Count * 100 : 0)"
                                        Color="Color.Secondary" Size="Size.Small" Style="width:80px;" />
                                    <MudChip T="string" Size="Size.Small" Color="Color.Default">@grp.Count()</MudChip>
                                </MudStack>
                            </MudStack>
                        }
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private List<PersonRecord> _records = new();
    private int _municipalityCount;
    private int _leadCompanyCount;

    private record CourseItem(string Name, string Category, string Icon, string Color);
    private record InstructorItem(string Name, string Speciality, string Initial, Color AvatarColor);

    private readonly List<CourseItem> _courses = new()
    {
        new("Data Science",               "Analytics",     Icons.Material.Filled.Analytics,    "#4facfe"),
        new("Cybersecurity",              "Security",      Icons.Material.Filled.Security,      "#f5576c"),
        new("IoT",                        "Hardware/SW",   Icons.Material.Filled.DeviceHub,     "#43e97b"),
        new("AI Multimedia Content Dev",  "AI / Creative", Icons.Material.Filled.AutoAwesome,   "#f093fb"),
        new("AI Cloud Dev",               "Cloud / AI",    Icons.Material.Filled.Cloud,         "#4facfe"),
        new("Cloud Admin",                "Cloud",         Icons.Material.Filled.CloudQueue,    "#fa709a"),
        new("Software Dev",               "Engineering",   Icons.Material.Filled.Code,          "#fee140"),
    };

    private readonly List<InstructorItem> _instructors = new()
    {
        new("Sibusiso Skhosana", "Facilitation · Recruitment", "S", Color.Primary),
        new("Chulumanco Mbete",  "Platform Admin",             "C", Color.Secondary),
    };

    protected override void OnInitialized()
    {
        ExcelDataService.OnDataChanged += Reload;
        LoadData();
    }
    private void Reload() { LoadData(); InvokeAsync(StateHasChanged); }
    public void Dispose() => ExcelDataService.OnDataChanged -= Reload;

    private void LoadData()
    {
        _records           = ExcelDataService.GetRecords();
        _municipalityCount = _records.Select(r => r.LocalMunicipality).Where(s => !string.IsNullOrWhiteSpace(s)).Distinct().Count();
        _leadCompanyCount  = _records.Select(r => r.LeadCompany).Where(s => !string.IsNullOrWhiteSpace(s)).Distinct().Count();
    }
}
